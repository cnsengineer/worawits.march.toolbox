<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CNS : PDF Tools 2026 (Pro Edition)</title>
    
    <meta name="theme-color" content="#0046be">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&family=Niramit:wght@400;700&family=Krub:wght@400;700&family=Mali:wght@400;700&family=Prompt:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0f172a; --accent: #0046be; --accent-hover: #003399;
            --bg: #f3f6fc; --sidebar-bg: #ffffff; --text-main: #1e293b; --text-sec: #64748b;
            --border: #e2e8f0; --card-bg: #ffffff; --input-bg: #ffffff;
            --drop-bg: #f8fafc; --drop-border: #cbd5e1;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --sidebar-width: 280px;
        }
        [data-theme="dark"] {
            --primary: #f8fafc; --accent: #3b82f6; --accent-hover: #60a5fa;
            --bg: #0f172a; --sidebar-bg: #1e293b; --text-main: #f1f5f9; --text-sec: #94a3b8;
            --border: #334155; --card-bg: #1e293b; --input-bg: #334155;
            --drop-bg: #0f172a; --drop-border: #475569;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; }
        
        .top-controls { position: fixed; top: 20px; right: 20px; z-index: 1100; display: flex; gap: 10px; }
        .control-btn { background: var(--card-bg); border: 2px solid var(--border); padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; font-weight: 700; color: var(--text-main); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .control-btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-2px); }

        aside { width: var(--sidebar-width); background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem 1rem; box-shadow: 2px 0 15px rgba(0,0,0,0.03); z-index: 900; transition: transform 0.3s ease; }
        .brand { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .brand-logo { max-width: 160px; height: auto; margin-bottom: 15px; display: block; object-fit: contain; transition: transform 0.3s; }
        .brand-logo:hover { transform: scale(1.05); }
        .program-name { font-size: 1.2rem; font-weight: 800; color: var(--accent); margin: 0; }
        .company-name { font-size: 0.75rem; color: var(--text-sec); margin-top: 5px; font-weight: 500; }

        nav { flex: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; }
        nav::-webkit-scrollbar { width: 4px; }
        nav::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .nav-group-title { font-size: 0.75rem; color: var(--text-sec); font-weight: 700; margin: 15px 0 5px 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        nav button { width: 100%; text-align: left; padding: 10px 15px; margin-bottom: 3px; border: none; background: none; border-radius: 8px; color: var(--text-sec); cursor: pointer; font-family: 'Sarabun', sans-serif; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        nav button:hover { background: var(--bg); color: var(--accent); }
        nav button.active { background: rgba(0, 70, 190, 0.08); color: var(--accent); font-weight: 700; border-left: 4px solid var(--accent); }
        [data-theme="dark"] nav button.active { background: rgba(59, 130, 246, 0.15); }
        nav button i { width: 20px; text-align: center; font-size: 1rem; }
        
        .dev-info { margin-top: auto; font-size: 0.7rem; color: var(--text-sec); text-align: center; border-top: 1px solid var(--border); padding-top: 1rem; line-height: 1.6; }

        main { flex: 1; padding: 2rem; overflow-y: auto; position: relative; }
        .tool-panel { display: none; max-width: 900px; margin: 0 auto; animation: fadeIn 0.4s ease; }
        .tool-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .panel-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 1.5rem; }
        .panel-header h2 { color: var(--accent); margin: 0; display: flex; align-items: center; gap: 12px; font-size: 1.5rem; }
        .tool-desc { color: var(--text-sec); margin: 5px 0 0 0; font-size: 0.95rem; }

        .btn-reset { background: transparent; color: var(--text-sec); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-reset:hover { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        .card { background: var(--card-bg); border-radius: 12px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border); transition: background 0.3s; }
        .drop-zone { border: 2px dashed var(--drop-border); border-radius: 10px; padding: 3rem 1rem; text-align: center; cursor: pointer; transition: all 0.2s; background-color: var(--drop-bg); position: relative; overflow: hidden; }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background-color: rgba(0, 70, 190, 0.04); transform: translateY(-2px); }
        .drop-zone i { font-size: 3.5rem; color: var(--text-sec); margin-bottom: 1rem; transition: color 0.3s; }
        .drop-zone:hover i { color: var(--accent); }
        .drop-zone p { margin: 0; color: var(--text-sec); font-weight: 600; font-size: 1rem; }
        .drop-tip { display: block; font-size: 0.8rem; color: var(--text-sec); margin-top: 8px; opacity: 0.7; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: 'Sarabun', sans-serif; outline: none; transition: border 0.2s; font-size: 0.95rem; background: var(--input-bg); color: var(--text-main); }
        .form-group input:focus, .form-group select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0, 70, 190, 0.1); }
        
        /* Sliders Styles */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -7px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--border); border-radius: 2px; }

        .btn-action { width: 100%; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); color: #fff; padding: 15px; border: none; border-radius: 10px; font-size: 1.05rem; font-weight: 600; cursor: pointer; margin-top: 2rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; font-family: 'Sarabun', sans-serif; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 70, 190, 0.3); }

        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-sec); cursor: pointer; transition: all 0.2s; }
        .btn-sm:hover { border-color: var(--accent); color: var(--accent); }
        .selection-controls { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }

        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; margin-top: 20px; max-height: 450px; overflow-y: auto; padding: 10px; background: var(--drop-bg); border-radius: 8px; border: 1px solid var(--border); }
        .page-thumb, .img-card { position: relative; border: 2px solid transparent; border-radius: 6px; overflow: hidden; transition: all 0.2s; background: #fff; aspect-ratio: 1/1.414; display: flex; flex-direction: column; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; user-select: none; }
        .img-card { aspect-ratio: auto; min-height: 140px; cursor: grab; }
        .page-thumb img, .img-card img { width: 100%; height: 100%; object-fit: contain; display: block; background: #fff; }
        .page-thumb:hover, .img-card:hover { transform: scale(1.02); z-index: 10; box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        
        .card-remove-btn, .card-view-btn { position: absolute; top: 2px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.9rem; z-index: 20; opacity: 0.9; color: white; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .card-remove-btn { right: 2px; background: rgba(239, 68, 68, 1); }
        .card-view-btn { left: 2px; background: rgba(59, 130, 246, 1); }
        .card-remove-btn:hover { transform: scale(1.1); }

        .card-label { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: #fff; font-size: 0.7rem; padding: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .page-number { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff; font-size: 0.75rem; text-align: center; padding: 2px 0; font-weight: bold; }
        .page-thumb.selected-delete { border-color: var(--danger); opacity: 0.6; transform: scale(0.95); }
        .page-thumb.selected-delete::after { content: '\f2ed'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: var(--danger); text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .page-thumb.selected-keep { border-color: var(--success); opacity: 1; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3); }
        .page-thumb.selected-keep::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 5px; right: 5px; font-size: 0.8rem; color: #fff; background: var(--success); border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; }

        .privacy-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-top: 1.5rem; width: fit-content; border: 1px solid rgba(16, 185, 129, 0.2); }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; background: var(--card-bg); color: var(--text-main); padding: 14px 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); display: flex; align-items: center; gap: 12px; animation: slideUp 0.3s; border-left: 5px solid var(--accent); min-width: 280px; font-weight: 600; font-size: 0.95rem; }
        .toast.success { border-left-color: var(--success); } .toast.error { border-left-color: var(--danger); }
        .toast i { font-size: 1.4rem; } .toast.success i { color: var(--success); } .toast.error i { color: var(--danger); }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        [data-theme="dark"] .overlay { background: rgba(15, 23, 42, 0.95); }
        .spinner-container { text-align: center; background: var(--card-bg); padding: 3rem; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 1px solid var(--border); width: 350px; max-width: 90%; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1.5rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-track { width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-top: 15px; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.3s ease; }
        .progress-text { font-size: 0.9rem; font-weight: 700; color: var(--accent); margin-top: 8px; display: block; }

        .qv-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .qv-content { position: relative; max-width: 95%; max-height: 95%; box-shadow: 0 0 30px rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .qv-content img { max-width: 100%; max-height: 90vh; display: block; object-fit: contain; }
        .qv-close { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; transition: background 0.2s; backdrop-filter: blur(4px); }
        .qv-close:hover { background: var(--danger); }

        #watermark-preview-wrapper { position: relative; max-width: 100%; margin: 0 auto; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; background: #e2e8f0; display: inline-block; }
        #watermark-preview-img { width: 100%; display: block; max-height: 400px; object-fit: contain; }
        #watermark-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); white-space: nowrap; pointer-events: none; text-align: center; line-height: 1; font-weight: bold; font-family: 'Sarabun', sans-serif; transform-origin: center center; }

        .menu-toggle { display: none; position: fixed; top: 20px; left: 20px; z-index: 1001; background: var(--accent); color: #fff; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 800; backdrop-filter: blur(2px); }
        @media (max-width: 768px) { .menu-toggle { display: block; } aside { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 10px 0 20px rgba(0,0,0,0.1); } aside.open { transform: translateX(0); } main { padding: 5rem 1rem 2rem 1rem; } .grid-2 { grid-template-columns: 1fr; gap: 1rem; } .top-controls { top: 15px; right: 15px; } .control-btn { padding: 6px 12px; } .menu-overlay.active { display: block; } }

        .sig-container { border: 2px solid var(--border); border-radius: 8px; background: #fff; position: relative; width: 100%; max-width: 600px; margin: 0 auto; touch-action: none; }
        canvas#sig-canvas { width: 100%; height: 300px; display: block; cursor: crosshair; }
        .sig-controls { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--drop-bg); border-top: 1px solid var(--border); border-radius: 0 0 8px 8px; }
        .color-opts { display: flex; gap: 8px; }
        .color-btn { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 0 0 1px var(--border); transition: transform 0.2s; }
        .color-btn.active { transform: scale(1.2); box-shadow: 0 0 0 2px var(--accent); }
        .color-btn[data-color="#000000"] { background: #000; }
        .color-btn[data-color="#00008b"] { background: #00008b; }

        /* --- New Signature Drag & Drop Styles --- */
        #sign-workspace { text-align: center; margin-top: 20px; display: none; }
        .pdf-nav { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px; }
        .pdf-nav button { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-family: 'Sarabun'; font-weight: 600; transition: all 0.2s; }
        .pdf-nav button:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .pdf-nav button:disabled { opacity: 0.5; cursor: not-allowed; }
        #sign-pdf-wrapper { position: relative; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border); max-width: 100%; overflow: hidden; background: white; touch-action: none; }
        #sign-pdf-canvas-preview { max-width: 100%; display: block; }
        
        .draggable-sig { position: absolute; border: 2px dashed rgba(59, 130, 246, 0.8); background: rgba(59, 130, 246, 0.05); cursor: move; touch-action: none; user-select: none; z-index: 100; min-width: 50px; min-height: 30px; }
        .draggable-sig img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        .sig-resizer { position: absolute; bottom: -6px; right: -6px; width: 16px; height: 16px; background: var(--accent); border-radius: 50%; border: 2px solid white; cursor: nwse-resize; z-index: 101; }
        .sig-deleter { position: absolute; top: -10px; right: -10px; width: 22px; height: 22px; background: var(--danger); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; font-weight: bold; z-index: 101; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* --- Add Text Drag & Drop Styles --- */
        #addtext-workspace { text-align: center; margin-top: 20px; display: none; }
        #addtext-pdf-wrapper { position: relative; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border); max-width: 100%; overflow: hidden; background: white; touch-action: none; text-align: left; }
        #addtext-pdf-canvas-preview { max-width: 100%; display: block; }
        
        .draggable-text { position: absolute; border: 2px dashed rgba(16, 185, 129, 0.8); background: rgba(16, 185, 129, 0.05); cursor: move; touch-action: none; user-select: none; z-index: 100; min-width: 40px; min-height: 24px; display: flex; align-items: center; justify-content: flex-start; padding: 2px; box-sizing: border-box; }
        .draggable-text span { display: block; white-space: pre-wrap; word-wrap: break-word; line-height: 1.1; pointer-events: none; width: 100%; }
        .text-resizer { position: absolute; bottom: -6px; right: -6px; width: 16px; height: 16px; background: var(--success); border-radius: 50%; border: 2px solid white; cursor: nwse-resize; z-index: 101; }
        .text-rotator { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 16px; height: 16px; background: var(--warning); border-radius: 50%; border: 2px solid white; cursor: grab; z-index: 101; }
        .text-rotator::after { content: ''; position: absolute; top: 14px; left: 6px; width: 2px; height: 10px; background: var(--warning); }
        .text-deleter { position: absolute; top: -10px; right: -10px; width: 22px; height: 22px; background: var(--danger); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; font-weight: bold; z-index: 101; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--drop-border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--text-sec); }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="menu-overlay" onclick="toggleSidebar()"></div>
    
    <div class="top-controls">
        <button class="control-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>
        <button class="control-btn" onclick="toggleLanguage()">
            <i class="fas fa-globe"></i> <span id="lang-label">TH</span>
        </button>
    </div>

    <aside id="sidebar">
        <div class="brand">
            <img src="Logo.png" alt="Logo" class="brand-logo" onerror="this.style.display='none';">
            <h1 class="program-name">CNS : PDF Tools 2026</h1>
            <p class="company-name">CNS Computer Co., Ltd.</p>
        </div>
        <nav>
            <div class="nav-group-title" data-i18n="grp_convert">Convert</div>
            <button class="active" onclick="switchTab('pdf2img')"><i class="fas fa-image"></i> <span data-i18n="menu_pdf2img">PDF to Image</span></button>
            <button onclick="switchTab('img2pdf')"><i class="fas fa-images"></i> <span data-i18n="menu_img2pdf">Image to PDF</span></button>
            <button onclick="switchTab('compress')"><i class="fas fa-compress-arrows-alt"></i> <span data-i18n="menu_compress">Compress PDF</span></button>
            
            <div class="nav-group-title" data-i18n="grp_edit">Edit</div>
            <button onclick="switchTab('addtext')"><i class="fas fa-font"></i> <span data-i18n="menu_addtext">Add Text</span></button>
            <button onclick="switchTab('sign')"><i class="fas fa-file-signature"></i> <span data-i18n="menu_sign">Sign PDF</span></button>
            <button onclick="switchTab('metadata')"><i class="fas fa-tags"></i> <span data-i18n="menu_metadata">Edit Metadata</span></button>
            <button onclick="switchTab('merge')"><i class="fas fa-layer-group"></i> <span data-i18n="menu_merge">Merge PDF</span></button>
            <button onclick="switchTab('split')"><i class="fas fa-cut"></i> <span data-i18n="menu_split">Split PDF</span></button>
            <button onclick="switchTab('rotate')"><i class="fas fa-sync-alt"></i> <span data-i18n="menu_rotate">Rotate PDF</span></button>
            <button onclick="switchTab('delete')"><i class="fas fa-trash-alt"></i> <span data-i18n="menu_delete">Delete Pages</span></button>
            
            <div class="nav-group-title" data-i18n="grp_util">Utilities</div>
            <button onclick="switchTab('watermark')"><i class="fas fa-stamp"></i> <span data-i18n="menu_watermark">Watermark</span></button>
            <button onclick="switchTab('pagenumber')"><i class="fas fa-list-ol"></i> <span data-i18n="menu_pagenum">Page Numbers</span></button>
            <button onclick="switchTab('protect')"><i class="fas fa-lock"></i> <span data-i18n="menu_protect">Protect PDF</span></button>
            <button onclick="switchTab('unlock')"><i class="fas fa-unlock"></i> <span data-i18n="menu_unlock">Unlock PDF</span></button>
        </nav>
        <div class="dev-info">
            &copy; 2026 CNS Computer Co., Ltd.<br>
            <span style="color: var(--accent); font-weight: 600;">Developed by MaRcH WoRaWiT</span>
        </div>
    </aside>

    <main>
        <div id="pdf2img" class="tool-panel active">
            <div class="panel-header"><div><h2><i class="fas fa-image"></i> <span data-i18n="title_pdf2img">PDF to Image</span></h2><p class="tool-desc" data-i18n="desc_pdf2img">Convert pages to high-quality images.</p></div><button class="btn-reset" onclick="resetTool('pdf2img')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-pdf2img">
                    <div id="label-pdf2img">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p data-i18n="drop_pdf">Drop PDF here</p>
                    </div>
                    <span class="drop-tip" data-i18n="tip_pdf">Max size 50MB per file</span>
                    <input type="file" id="inp-pdf2img" accept="application/pdf" hidden>
                </div>
                <div id="preview-pdf2img-container" style="display:none;"><div class="selection-controls"><button class="btn-sm" onclick="toggleSelectAll('pdf2img',true)" data-i18n="btn_sel_all">All</button><button class="btn-sm" onclick="toggleSelectAll('pdf2img',false)" data-i18n="btn_sel_none">None</button><span style="margin-left:auto;font-size:0.8rem;color:var(--text-sec);" data-i18n="hint_shift">Tip: Hold Shift to select range</span></div><div id="grid-pdf2img" class="preview-grid"></div></div>
                <div class="grid-2">
                    <div class="form-group"><label data-i18n="lbl_pages">Pages</label><input type="text" id="range-pdf2img" oninput="syncInputToPreview('pdf2img')" data-i18n-placeholder="ph_pages" placeholder="1, 3-5"></div>
                    <div class="form-group"><label data-i18n="lbl_quality">Quality</label><select id="scale-pdf2img"><option value="1.5" data-i18n="opt_std">Standard</option><option value="2.0" selected data-i18n="opt_high">High</option><option value="3.0" data-i18n="opt_ultra">Ultra</option></select></div>
                    <div class="form-group"><label data-i18n="lbl_format">Format</label><select id="format-pdf2img"><option value="jpeg">JPG</option><option value="png">PNG</option></select></div>
                    <div class="form-group"><label data-i18n="lbl_mode">Download</label><select id="zip-pdf2img"><option value="smart" data-i18n="opt_smart">Auto</option><option value="force" data-i18n="opt_zip">Always ZIP</option></select></div>
                </div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processPdfToImg()" data-i18n="btn_convert">Convert Now</button>
            </div>
        </div>

        <div id="img2pdf" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-images"></i> <span data-i18n="title_img2pdf">Image to PDF</span></h2><p class="tool-desc" data-i18n="desc_img2pdf">Combine images into a single PDF.</p></div><button class="btn-reset" onclick="resetTool('img2pdf')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-img2pdf"><i class="fas fa-plus-circle"></i><p data-i18n="drop_img">Add Images</p><span class="drop-tip" data-i18n="tip_img">Support JPG, PNG</span><input type="file" id="inp-img2pdf" accept="image/*" multiple hidden></div>
                <div id="preview-img2pdf-container" style="display:none;"><div id="list-img2pdf" class="preview-grid" style="min-height:100px;"></div><p class="helper-text text-center" style="font-size:0.8rem;color:var(--text-sec);margin-top:10px;"><i class="fas fa-hand-rock"></i> <span data-i18n="help_drag">Drag to reorder</span></p></div>
                <div class="grid-2">
                    <div class="form-group"><label data-i18n="lbl_size">Paper Size</label><select id="size-img2pdf"><option value="A4">A4</option><option value="Auto" data-i18n="opt_auto">Fit Image</option></select></div>
                    <div class="form-group"><label data-i18n="lbl_margin">Margin</label><select id="margin-img2pdf"><option value="0" data-i18n="opt_no_margin">None</option><option value="20" data-i18n="opt_small">Small</option><option value="50" selected data-i18n="opt_std_margin">Standard</option></select></div>
                </div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processImgToPdf()" data-i18n="btn_create">Create PDF</button>
            </div>
        </div>

        <div id="addtext" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-font"></i> <span data-i18n="title_addtext">Add Text</span></h2><p class="tool-desc" data-i18n="desc_addtext">Add text boxes to PDF.</p></div><button class="btn-reset" onclick="resetTool('addtext')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-addtext">
                    <div id="label-addtext">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select PDF</p>
                    </div>
                    <input type="file" id="inp-addtext" accept="application/pdf" hidden>
                </div>

                <div id="addtext-workspace">
                    <div class="pdf-nav">
                        <button onclick="changeAddTextPage(-1)" id="addtext-btn-prev" disabled><i class="fas fa-chevron-left"></i> <span data-i18n="btn_prev">ก่อนหน้า</span></button>
                        <span style="font-weight: 600;"><span data-i18n="lbl_page">Page</span> <span id="addtext-current-page">1</span> / <span id="addtext-total-pages">1</span></span>
                        <button onclick="changeAddTextPage(1)" id="addtext-btn-next"><span data-i18n="btn_next">ถัดไป</span> <i class="fas fa-chevron-right"></i></button>
                    </div>
                    
                    <div id="addtext-pdf-wrapper">
                        <canvas id="addtext-pdf-canvas-preview"></canvas>
                    </div>
                </div>

                <div class="grid-2" style="margin-top:1.5rem; background: var(--drop-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label data-i18n="lbl_input_text">ข้อความ</label>
                        <textarea id="text-addtext-val" rows="2" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: 'Sarabun';" data-i18n-placeholder="ph_input_text" placeholder="พิมพ์ข้อความที่ต้องการ..."></textarea>
                    </div>
                    <div class="form-group">
                        <label data-i18n="lbl_font">แบบอักษร</label>
                        <select id="font-addtext-val" style="font-family: inherit;">
                            <option value="Sarabun" style="font-family: 'Sarabun';">Sarabun (สารบรรณ)</option>
                            <option value="Niramit" style="font-family: 'Niramit';">Niramit (นิรมิต)</option>
                            <option value="Krub" style="font-family: 'Krub';">Krub (กรับ)</option>
                            <option value="Mali" style="font-family: 'Mali';">Mali (มะลิ - น่ารัก)</option>
                            <option value="Prompt" style="font-family: 'Prompt';">Prompt (พร้อม - โมเดิร์น)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="lbl_color">สีข้อความ</label>
                        <input type="color" id="color-addtext-val" value="#000000" style="height: 45px; padding: 2px; cursor: pointer;">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1; display: flex; justify-content: flex-end;">
                        <button type="button" class="btn-sm" style="background:var(--success); color:white; border:none; padding: 10px 20px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;" onclick="addTextToPreview()"><i class="fas fa-plus"></i> <span data-i18n="btn_add_to_page">เพิ่มลงหน้านี้</span></button>
                    </div>
                </div>

                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processAddText()" data-i18n="btn_save_pdf">Save PDF</button>
            </div>
        </div>

        <div id="sign" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-file-signature"></i> <span data-i18n="title_sign">Sign PDF</span></h2><p class="tool-desc" data-i18n="desc_sign">Draw signature and place on PDF.</p></div><button class="btn-reset" onclick="resetTool('sign')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-sign">
                    <div id="label-sign">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select PDF</p>
                    </div>
                    <input type="file" id="inp-sign" accept="application/pdf" hidden>
                </div>

                <!-- New Interactive Workspace -->
                <div id="sign-workspace">
                    <div class="pdf-nav">
                        <button onclick="changeSignPage(-1)" id="sign-btn-prev" disabled><i class="fas fa-chevron-left"></i> <span data-i18n="btn_prev">ก่อนหน้า</span></button>
                        <span style="font-weight: 600;"><span data-i18n="lbl_page">Page</span> <span id="sign-current-page">1</span> / <span id="sign-total-pages">1</span></span>
                        <button onclick="changeSignPage(1)" id="sign-btn-next"><span data-i18n="btn_next">ถัดไป</span> <i class="fas fa-chevron-right"></i></button>
                    </div>
                    
                    <div id="sign-pdf-wrapper">
                        <canvas id="sign-pdf-canvas-preview"></canvas>
                        <!-- Draggable signatures will be appended here -->
                    </div>
                </div>

                <div class="form-group" style="margin-top:1.5rem;">
                    <label data-i18n="lbl_draw_sig">Draw Signature</label>
                    <div class="sig-container">
                        <canvas id="sig-canvas"></canvas>
                        <div class="sig-controls">
                            <div class="color-opts">
                                <div class="color-btn active" data-color="#000000" onclick="setSigColor(this)"></div>
                                <div class="color-btn" data-color="#00008b" onclick="setSigColor(this)"></div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button type="button" class="btn-sm" onclick="clearSig()" data-i18n="btn_clear_sig">Clear</button>
                                <button type="button" class="btn-sm" style="background:var(--accent); color:white; border:none;" onclick="addSignatureToPreview()"><i class="fas fa-plus"></i> <span data-i18n="btn_add_to_page">เพิ่มลงหน้านี้</span></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processSign()" data-i18n="btn_sign">Sign PDF</button>
            </div>
        </div>

        <div id="metadata" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-tags"></i> <span data-i18n="title_metadata">Edit Metadata</span></h2><p class="tool-desc" data-i18n="desc_metadata">Change PDF title, author, and keywords.</p></div><button class="btn-reset" onclick="resetTool('metadata')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-metadata">
                    <div id="label-metadata">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select PDF</p>
                    </div>
                    <input type="file" id="inp-metadata" accept="application/pdf" hidden>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label data-i18n="lbl_meta_title">Title</label><input type="text" id="meta-title" data-i18n-placeholder="ph_meta_title" placeholder="Document Title"></div>
                    <div class="form-group"><label data-i18n="lbl_meta_author">Author</label><input type="text" id="meta-author" data-i18n-placeholder="ph_meta_author" placeholder="Author Name"></div>
                    <div class="form-group"><label data-i18n="lbl_meta_subject">Subject</label><input type="text" id="meta-subject" data-i18n-placeholder="ph_meta_subject" placeholder="Subject"></div>
                    <div class="form-group"><label data-i18n="lbl_meta_keywords">Keywords</label><input type="text" id="meta-keywords" data-i18n-placeholder="ph_meta_keywords" placeholder="Keywords"></div>
                </div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processMetadata()" data-i18n="btn_metadata">Save Metadata</button>
            </div>
        </div>

        <div id="compress" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-compress-arrows-alt"></i> <span data-i18n="title_compress">Compress PDF</span></h2><p class="tool-desc" data-i18n="desc_compress">Reduce file size by optimizing content.</p></div><button class="btn-reset" onclick="resetTool('compress')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-compress">
                    <div id="label-compress">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Drop PDF here</p>
                    </div>
                    <span class="drop-tip" data-i18n="tip_pdf">Max size 50MB per file</span>
                    <input type="file" id="inp-compress" accept="application/pdf" hidden>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label data-i18n="lbl_comp_level">Compression Level</label><select id="level-compress"><option value="0.8" data-i18n="opt_comp_low">Low Compression (Best Quality)</option><option value="0.6" selected data-i18n="opt_comp_med">Medium Compression (Balanced)</option><option value="0.4" data-i18n="opt_comp_high">High Compression (Smallest Size)</option></select></div>
                    <div class="form-group"><label data-i18n="lbl_filename">Output Name</label><input type="text" id="filename-compress" data-i18n-placeholder="ph_filename_auto" placeholder="Auto"></div>
                </div>
                <div class="privacy-badge"><i class="fas fa-info-circle"></i><span style="font-size:0.8rem" data-i18n="note_compress">Re-encodes pages as images. Text selection may be lost.</span></div>
                <button class="btn-action" onclick="processCompress()" data-i18n="btn_compress">Compress PDF</button>
            </div>
        </div>

        <div id="merge" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-layer-group"></i> <span data-i18n="title_merge">Merge PDF</span></h2><p class="tool-desc" data-i18n="desc_merge">Combine multiple PDFs into one.</p></div><button class="btn-reset" onclick="resetTool('merge')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-merge"><i class="fas fa-plus-circle"></i><p data-i18n="drop_pdfs">Add PDF Files</p><span class="drop-tip" data-i18n="tip_merge">Drag multiple files</span><input type="file" id="inp-merge" accept="application/pdf" multiple hidden></div>
                <div id="preview-merge-container" style="display:none;"><div id="list-merge" class="preview-grid" style="min-height:100px;"></div></div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processMerge()" data-i18n="btn_merge">Merge Files</button>
            </div>
        </div>

        <div id="split" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-cut"></i> <span data-i18n="title_split">Split PDF</span></h2><p class="tool-desc" data-i18n="desc_split">Extract pages from PDF.</p></div><button class="btn-reset" onclick="resetTool('split')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-split">
                    <div id="label-split">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf_main">Select PDF</p>
                    </div>
                    <input type="file" id="inp-split" accept="application/pdf" hidden>
                </div>
                <div id="preview-split-container" style="display:none;"><div class="selection-controls"><button class="btn-sm" onclick="toggleSelectAll('split',true)" data-i18n="btn_sel_all">All</button><button class="btn-sm" onclick="toggleSelectAll('split',false)" data-i18n="btn_sel_none">None</button><span style="margin-left:auto;font-size:0.8rem;color:var(--text-sec);" data-i18n="hint_shift">Tip: Hold Shift to select range</span></div><div id="grid-split" class="preview-grid"></div></div>
                <div class="grid-2">
                    <div class="form-group"><label data-i18n="lbl_split_mode">Mode</label><select id="mode-split" onchange="toggleSplitMode()"><option value="range" data-i18n="opt_range">Extract Range</option><option value="all" data-i18n="opt_all">Explode (All Pages)</option></select></div>
                    <div class="form-group" id="group-range-split"><label data-i18n="lbl_specify_pages">Pages</label><input type="text" id="val-split" oninput="syncInputToPreview('split')" data-i18n-placeholder="ph_split" placeholder="e.g. 1-3, 5"></div>
                </div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processSplit()" data-i18n="btn_split">Split PDF</button>
            </div>
        </div>

        <div id="rotate" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-sync-alt"></i> <span data-i18n="title_rotate">Rotate PDF</span></h2><p class="tool-desc" data-i18n="desc_rotate">Fix orientation.</p></div><button class="btn-reset" onclick="resetTool('rotate')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-rotate">
                    <div id="label-rotate">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select PDF</p>
                    </div>
                    <input type="file" id="inp-rotate" accept="application/pdf" hidden>
                </div>
                <div id="preview-rotate-container" style="display:none;"><div class="selection-controls"><button class="btn-sm" onclick="toggleSelectAll('rotate',true)" data-i18n="btn_sel_all">All</button><button class="btn-sm" onclick="toggleSelectAll('rotate',false)" data-i18n="btn_sel_none">None</button><span style="margin-left:auto;font-size:0.8rem;color:var(--text-sec);" data-i18n="hint_shift">Tip: Hold Shift to select range</span></div><div id="grid-rotate" class="preview-grid"></div></div>
                <div class="grid-2">
                    <div class="form-group"><label data-i18n="lbl_direction">Direction</label><select id="angle-rotate" onchange="updateRotateVisuals()"><option value="90" data-i18n="rot_90">Rotate Right 90°</option><option value="180" data-i18n="rot_180">Rotate 180°</option><option value="270" data-i18n="rot_270">Rotate Left 90°</option></select></div>
                    <div class="form-group"><label data-i18n="lbl_rotate_pages">Pages</label><input type="text" id="pages-rotate" oninput="syncInputToPreview('rotate')" data-i18n-placeholder="ph_rotate" placeholder="Empty = All"></div>
                </div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processRotate()" data-i18n="btn_rotate">Rotate & Save</button>
            </div>
        </div>

        <div id="watermark" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-stamp"></i> <span data-i18n="title_watermark">Watermark</span></h2><p class="tool-desc" data-i18n="desc_watermark">Add text stamp.</p></div><button class="btn-reset" onclick="resetTool('watermark')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-watermark">
                    <div id="label-watermark">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select PDF</p>
                    </div>
                    <input type="file" id="inp-watermark" accept="application/pdf" hidden>
                </div>
                
                <div id="preview-watermark-container" style="display:none;margin-bottom:1.5rem;text-align:center;">
                    <div id="watermark-preview-wrapper">
                        <img id="watermark-preview-img" src="">
                        <div id="watermark-overlay"></div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label data-i18n="lbl_wm_text">Text</label>
                        <input type="text" id="text-watermark" oninput="updateWatermarkPreview()" data-i18n-placeholder="ph_wm_text" placeholder="CONFIDENTIAL" value="CONFIDENTIAL">
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="lbl_color">Color</label>
                        <select id="color-watermark" onchange="updateWatermarkPreview()">
                            <option value="rgba(128, 128, 128, 1)" data-i18n="color_gray">Gray</option>
                            <option value="rgba(255, 0, 0, 1)" data-i18n="color_red">Red</option>
                            <option value="rgba(0, 0, 255, 1)" data-i18n="color_blue">Blue</option>
                            <option value="rgba(0, 0, 0, 1)" data-i18n="color_black">Black</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label><span data-i18n="lbl_font_size">Size</span>: <span id="lbl-size-val">40</span></label>
                        <input type="range" id="size-watermark" min="10" max="200" value="40" oninput="updateWatermarkPreview()">
                    </div>

                    <div class="form-group">
                        <label><span data-i18n="lbl_rotate">Rotation</span>: <span id="lbl-rot-val">-45°</span></label>
                        <input type="range" id="rot-watermark" min="-180" max="180" value="-45" oninput="updateWatermarkPreview()">
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label><span data-i18n="lbl_opacity">Opacity</span>: <span id="lbl-op-val">50%</span></label>
                        <input type="range" id="opacity-watermark" min="0" max="100" value="50" oninput="updateWatermarkPreview()">
                    </div>
                </div>

                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processWatermark()" data-i18n="btn_watermark">Add Watermark</button>
            </div>
        </div>

        <div id="pagenumber" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-list-ol"></i> <span data-i18n="title_pagenum">Page Numbers</span></h2><p class="tool-desc" data-i18n="desc_pagenum">Add page numbering.</p></div><button class="btn-reset" onclick="resetTool('pagenumber')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-pagenumber">
                    <div id="label-pagenumber">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select PDF</p>
                    </div>
                    <input type="file" id="inp-pagenumber" accept="application/pdf" hidden>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label data-i18n="lbl_pos">Position</label><select id="pos-pagenumber"><option value="BC" selected data-i18n="pos_bc">Bottom Center</option><option value="BR" data-i18n="pos_br">Bottom Right</option><option value="BL" data-i18n="pos_bl">Bottom Left</option><option value="TC" data-i18n="pos_tc">Top Center</option><option value="TR" data-i18n="pos_tr">Top Right</option></select></div>
                    <div class="form-group"><label data-i18n="lbl_start_num">Start At</label><input type="number" id="start-pagenumber" value="1"></div>
                    <div class="form-group"><label data-i18n="lbl_format">Format</label><select id="fmt-pagenumber"><option value="n">1, 2, 3...</option><option value="p_n">Page 1, Page 2...</option><option value="n_of_t">1 of 10...</option></select></div>
                </div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processPageNumber()" data-i18n="btn_pagenum">Add Numbers</button>
            </div>
        </div>

        <div id="protect" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-lock"></i> <span data-i18n="title_protect">Protect PDF</span></h2><p class="tool-desc" data-i18n="desc_protect">Encrypt with password.</p></div><button class="btn-reset" onclick="resetTool('protect')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-protect">
                    <div id="label-protect">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select PDF</p>
                    </div>
                    <input type="file" id="inp-protect" accept="application/pdf" hidden>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label data-i18n="lbl_pass_user">Open Password</label><input type="password" id="pass-protect-u" data-i18n-placeholder="ph_pass_u" placeholder="Required to Open"></div>
                    <div class="form-group"><label data-i18n="lbl_pass_owner">Owner Password (Optional)</label><input type="password" id="pass-protect-o" data-i18n-placeholder="ph_pass_o" placeholder="Required to Edit"></div>
                </div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processProtect()" data-i18n="btn_protect">Encrypt PDF</button>
            </div>
        </div>

        <div id="unlock" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-unlock"></i> <span data-i18n="title_unlock">Unlock PDF</span></h2><p class="tool-desc" data-i18n="desc_unlock">Remove password security.</p></div><button class="btn-reset" onclick="resetTool('unlock')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-unlock">
                    <div id="label-unlock">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select Protected PDF</p>
                    </div>
                    <input type="file" id="inp-unlock" accept="application/pdf" hidden>
                </div>
                <div class="form-group" style="margin-top:20px;"><label data-i18n="lbl_pass_curr">Current Password</label><input type="password" id="pass-unlock" data-i18n-placeholder="ph_pass_unlock" placeholder="Enter password to unlock"></div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processUnlock()" data-i18n="btn_unlock">Unlock PDF</button>
            </div>
        </div>

        <div id="delete" class="tool-panel">
            <div class="panel-header"><div><h2><i class="fas fa-trash-alt"></i> <span data-i18n="title_delete">Delete Pages</span></h2><p class="tool-desc" data-i18n="desc_delete">Remove unwanted pages.</p></div><button class="btn-reset" onclick="resetTool('delete')"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button></div>
            <div class="card">
                <div class="drop-zone" id="dz-delete">
                    <div id="label-delete">
                        <i class="fas fa-file-pdf"></i>
                        <p data-i18n="drop_pdf">Select PDF</p>
                    </div>
                    <input type="file" id="inp-delete" accept="application/pdf" hidden>
                </div>
                <div id="preview-delete-container" style="display:none;"><div class="selection-controls"><button class="btn-sm" onclick="toggleSelectAll('delete',true)" data-i18n="btn_sel_all">All</button><button class="btn-sm" onclick="toggleSelectAll('delete',false)" data-i18n="btn_sel_none">None</button><span style="margin-left:auto;font-size:0.8rem;color:var(--text-sec);" data-i18n="hint_shift">Tip: Hold Shift to select range</span></div><p class="helper-text" style="color:var(--danger);font-size:0.9rem;margin:10px 0;"><i class="fas fa-hand-pointer"></i> <span data-i18n="help_click_delete">Select pages to delete</span></p><div id="grid-delete" class="preview-grid"></div></div>
                <div class="form-group" style="margin-top:1.5rem;"><label data-i18n="lbl_del_pages">Pages to Delete</label><input type="text" id="val-delete" oninput="syncInputToPreview('delete')" data-i18n-placeholder="ph_delete" placeholder="e.g. 2, 4-5"></div>
                <div class="privacy-badge"><i class="fas fa-shield-alt"></i><span data-i18n="privacy_note">ไฟล์ประมวลผลบนเครื่องของคุณ 100%</span></div>
                <button class="btn-action" onclick="processDelete()" style="background:var(--danger)" data-i18n="btn_delete">Delete Pages</button>
            </div>
        </div>
    </main>

    <div class="overlay" id="loading-overlay"><div class="spinner-container"><div class="spinner"></div><h3 id="loading-text" style="margin:0 0 10px 0;" data-i18n="msg_processing">Processing...</h3><div class="progress-track"><div class="progress-fill" id="progress-bar"></div></div><span class="progress-text" id="progress-percent">0%</span></div></div>
    <div class="qv-modal" id="quick-view-modal" onclick="closeQuickView()"><div class="qv-close" onclick="closeQuickView()"><i class="fas fa-times"></i></div><div class="qv-content" onclick="event.stopPropagation()"><img id="qv-img" src=""></div></div>
    <div id="toast-container"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;

        const i18n = {
            th: {
                grp_convert: "แปลงไฟล์", grp_edit: "แก้ไขไฟล์", grp_util: "เครื่องมือเสริม",
                menu_pdf2img: "PDF เป็น รูปภาพ", menu_img2pdf: "รูปภาพ เป็น PDF", menu_merge: "รวมไฟล์ PDF", menu_split: "แยกไฟล์ PDF", menu_rotate: "หมุนไฟล์", menu_watermark: "ใส่ลายน้ำ", menu_delete: "ลบหน้า", menu_compress: "บีบอัด PDF", menu_pagenum: "ใส่เลขหน้า", menu_protect: "ล็อกรหัสผ่าน", menu_unlock: "ปลดล็อก PDF", menu_sign: "เซ็นเอกสาร", menu_metadata: "แก้ไข Metadata", menu_addtext: "เพิ่มข้อความ",
                title_pdf2img: "แปลง PDF เป็นรูปภาพ", desc_pdf2img: "แปลงหน้าเอกสารเป็นไฟล์ JPG/PNG", drop_pdf: "ลากไฟล์ PDF มาวางที่นี่", lbl_pages: "เลือกหน้า", lbl_quality: "ความละเอียด", lbl_format: "นามสกุล", lbl_mode: "โหมด", btn_convert: "แปลงไฟล์", btn_reset: "ล้างค่า", btn_sel_all: "เลือกทั้งหมด", btn_sel_none: "ไม่เลือก",
                title_img2pdf: "สร้าง PDF จากรูปภาพ", desc_img2pdf: "รวมรูปภาพเป็น PDF", drop_img: "เพิ่มรูปภาพ (JPG, PNG)", lbl_size: "ขนาดกระดาษ", lbl_margin: "ขอบกระดาษ", btn_create: "สร้าง PDF",
                title_compress: "บีบอัด PDF", desc_compress: "ลดขนาดไฟล์โดยการแปลงเป็นภาพ", lbl_comp_level: "ระดับการบีบอัด", btn_compress: "บีบอัดไฟล์",
                title_merge: "รวมไฟล์ PDF", desc_merge: "รวมหลายไฟล์เป็นหนึ่งเดียว", drop_pdfs: "เพิ่มไฟล์ PDF", btn_merge: "รวมไฟล์",
                title_split: "แยกไฟล์ PDF", desc_split: "แยกหน้าหรือดึงบางหน้าออกมา", lbl_split_mode: "โหมด", lbl_specify_pages: "ระบุหน้า", btn_split: "แยกไฟล์",
                title_rotate: "หมุนไฟล์", desc_rotate: "แก้ไขด้านเอกสาร", lbl_direction: "ทิศทาง", lbl_rotate_pages: "หน้าที่จะหมุน", btn_rotate: "หมุนและบันทึก",
                title_watermark: "ใส่ลายน้ำ", desc_watermark: "ประทับตราข้อความ", lbl_wm_text: "ข้อความ", lbl_color: "สี", lbl_opacity: "ความโปร่งใส", btn_watermark: "สร้างลายน้ำ", lbl_font_size: "ขนาดตัวอักษร", lbl_rotate: "องศา",
                title_pagenum: "ใส่เลขหน้า", desc_pagenum: "รันเลขหน้าอัตโนมัติ", lbl_pos: "ตำแหน่ง", lbl_start_num: "เริ่มที่เลข", lbl_format: "รูปแบบ", btn_pagenum: "ใส่เลขหน้า",
                title_protect: "ล็อกรหัสผ่าน", desc_protect: "เข้ารหัสไฟล์ PDF", lbl_pass_user: "รหัสผ่านเปิดไฟล์ (User)", lbl_pass_owner: "รหัสผ่านแก้ไข (Owner)", btn_protect: "เข้ารหัส",
                title_unlock: "ปลดล็อก PDF", desc_unlock: "ลบรหัสผ่านออกจากไฟล์", lbl_pass_curr: "รหัสผ่านปัจจุบัน", btn_unlock: "ปลดล็อก",
                title_delete: "ลบหน้า", desc_delete: "ลบหน้าที่ไม่ต้องการ", lbl_del_pages: "ระบุหน้าที่จะลบ", btn_delete: "ลบหน้า",
                title_sign: "เซ็นเอกสาร", desc_sign: "วาดลายเซ็นและลากวางอิสระ", lbl_draw_sig: "วาดลายเซ็น", btn_clear_sig: "ล้าง", btn_sign: "บันทึก PDF ที่มีลายเซ็น", btn_add_to_page: "เพิ่มลงหน้านี้", lbl_page: "หน้า", btn_prev: "ก่อนหน้า", btn_next: "ถัดไป",
                title_addtext: "เพิ่มข้อความ (Add Text)", desc_addtext: "พิมพ์ข้อความและวางลงบนเอกสารได้อย่างอิสระ", lbl_input_text: "พิมพ์ข้อความ", lbl_font: "รูปแบบฟอนต์", btn_save_pdf: "บันทึก PDF",
                title_metadata: "แก้ไข Metadata", desc_metadata: "แก้ไขข้อมูล Title, Author, Keywords", lbl_meta_title: "ชื่อเอกสาร (Title)", lbl_meta_author: "ผู้แต่ง (Author)", lbl_meta_subject: "หัวข้อ (Subject)", lbl_meta_keywords: "คำค้นหา (Keywords)", btn_metadata: "บันทึกข้อมูล",
                
                msg_done: "เสร็จเรียบร้อย!", msg_err_pdf: "เลือกไฟล์ PDF ก่อน", msg_err_pass: "รหัสผ่านไม่ถูกต้อง", msg_add_files: "เพิ่มไฟล์แล้ว", msg_processing: "กำลังประมวลผล...",
                msg_err_merge: "ต้องใช้ไฟล์ PDF อย่างน้อย 2 ไฟล์", msg_err_pass_req: "กรุณาใส่รหัสผ่าน", 
                msg_no_text_added: "คุณยังไม่ได้เพิ่มข้อความลงบนหน้าเอกสาร (คลิก เพิ่มลงหน้านี้)", msg_text_added: "เพิ่มข้อความลงในหน้าปัจจุบันแล้ว สามารถลากหรือปรับขนาดได้", 
                msg_err_empty_text: "กรุณาพิมพ์ข้อความที่ต้องการเพิ่ม", msg_err_no_sig: "กรุณาวาดลายเซ็นก่อน", 
                msg_sig_added: "เพิ่มลายเซ็นลงในหน้าปัจจุบันแล้ว สามารถลากหรือปรับขนาดได้", msg_err_img: "กรุณาเลือกรูปภาพก่อน",
                msg_proc_page: "กำลังประมวลผลหน้าที่ {1} จาก {2}...",
                
                loading_init: "กำลังเตรียมพร้อม...", loading_gen: "กำลังสร้าง PDF...", loading_merge: "กำลังรวมไฟล์...", loading_split: "กำลังแยกไฟล์...", 
                loading_del: "กำลังลบหน้า...", loading_comp: "กำลังบีบอัด...", loading_font: "กำลังโหลดฟอนต์...", loading_apply_sig: "กำลังฝังลายเซ็น...", 
                loading_apply_txt: "กำลังฝังข้อความ...", loading_apply_wm: "กำลังฝังลายน้ำ...", loading_rotate: "กำลังหมุนไฟล์...", loading_meta: "กำลังอัปเดต Metadata...",
                
                opt_std: "มาตรฐาน", opt_high: "สูง", opt_ultra: "สูงสุด", opt_smart: "Auto (ไฟล์เดียวโหลดเลย)", opt_zip: "รวมเป็น ZIP เสมอ",
                opt_auto: "เท่าขนาดรูปจริง", opt_no_margin: "ไม่มีขอบ", opt_small: "ขอบเล็ก", opt_std_margin: "ขอบมาตรฐาน",
                opt_comp_low: "บีบอัดน้อย (ภาพชัด)", opt_comp_med: "ปานกลาง (สมดุล)", opt_comp_high: "บีบอัดมาก (ไฟล์เล็ก)",
                opt_range: "ดึงเฉพาะช่วงหน้า", opt_all: "แยกทุกหน้าเป็นไฟล์เดี่ยว",
                opt_last_page: "หน้าสุดท้าย", opt_first_page: "หน้าแรก", opt_all_pages: "ทุกหน้า",
                rot_90: "หมุนขวา 90°", rot_180: "หมุน 180°", rot_270: "หมุนซ้าย 90°",
                color_gray: "เทา", color_red: "แดง", color_blue: "น้ำเงิน", color_black: "ดำ",
                pos_bc: "ล่างตรงกลาง", pos_br: "ล่างขวา", pos_bl: "ล่างซ้าย", pos_tc: "บนตรงกลาง", pos_tr: "บนขวา",
                
                ph_pages: "เช่น 1, 3-5", ph_filename_auto: "ตั้งชื่อไฟล์ (ถ้าว่าง = Auto)", ph_split: "เช่น 1-3, 5", ph_rotate: "ว่างไว้ = หมุนทุกหน้า",
                ph_wm_text: "ข้อความลายน้ำ...", ph_delete: "เช่น 2, 4-5", 
                ph_pass_u: "รหัสสำหรับเปิดไฟล์", ph_pass_o: "รหัสสำหรับแก้ไข (ไม่บังคับ)", ph_pass_unlock: "ใส่รหัสเพื่อปลดล็อก",
                ph_input_text: "พิมพ์ข้อความที่ต้องการ...",
                help_click_delete: "คลิกที่รูปเพื่อเลือกหน้าที่จะลบ (สีแดง)", help_drag: "ลากรูปเพื่อเรียงลำดับใหม่ได้", note_compress: "ไฟล์ประมวลผลบนเครื่องของคุณ 100%",
                privacy_note: "ไฟล์ประมวลผลบนเครื่องของคุณ 100%",
                ph_meta_title: "เช่น รายงานประจำปี", ph_meta_author: "เช่น สมชาย ใจดี", ph_meta_subject: "เช่น รายงานการประชุม", ph_meta_keywords: "เช่น การเงิน, บัญชี",
                tip_pdf: "ขนาดสูงสุด 50MB", tip_img: "รองรับ JPG, PNG", tip_merge: "ลากได้หลายไฟล์พร้อมกัน", hint_shift: "Tip: กด Shift เพื่อเลือกเป็นช่วง"
            },
            en: {
                grp_convert: "Convert", grp_edit: "Edit", grp_util: "Utilities",
                menu_pdf2img: "PDF to Image", menu_img2pdf: "Image to PDF", menu_compress: "Compress PDF", menu_merge: "Merge PDF", menu_split: "Split PDF", menu_rotate: "Rotate PDF", menu_delete: "Delete Pages", menu_watermark: "Watermark", menu_pagenum: "Page Numbers", menu_protect: "Protect PDF", menu_unlock: "Unlock PDF", menu_sign: "Sign PDF", menu_metadata: "Edit Metadata", menu_addtext: "Add Text",
                title_pdf2img: "PDF to Image", desc_pdf2img: "Convert pages to images", drop_pdf: "Drop PDF here", lbl_pages: "Pages", lbl_quality: "Quality", lbl_format: "Format", lbl_mode: "Mode", btn_convert: "Convert", btn_reset: "Reset", btn_sel_all: "Select All", btn_sel_none: "Deselect All",
                title_img2pdf: "Image to PDF", desc_img2pdf: "Images to single PDF", drop_img: "Add Images", lbl_size: "Size", lbl_margin: "Margin", btn_create: "Create PDF",
                title_compress: "Compress PDF", desc_compress: "Reduce file size", lbl_comp_level: "Compression Level", btn_compress: "Compress",
                title_merge: "Merge PDF", desc_merge: "Combine PDFs", drop_pdfs: "Add PDFs", btn_merge: "Merge",
                title_split: "Split PDF", desc_split: "Extract pages", lbl_split_mode: "Mode", lbl_specify_pages: "Pages", btn_split: "Split",
                title_rotate: "Rotate PDF", desc_rotate: "Fix orientation", lbl_direction: "Direction", lbl_rotate_pages: "Pages", btn_rotate: "Rotate",
                title_watermark: "Watermark", desc_watermark: "Add text stamp", lbl_wm_text: "Text", lbl_color: "Color", lbl_opacity: "Opacity", btn_watermark: "Add Watermark", lbl_font_size: "Font Size", lbl_rotate: "Rotation",
                title_pagenum: "Page Numbers", desc_pagenum: "Add numbering", lbl_pos: "Position", lbl_start_num: "Start At", lbl_format: "Format", btn_pagenum: "Add Numbers",
                title_protect: "Protect PDF", desc_protect: "Encrypt file", lbl_pass_user: "Open Password", lbl_pass_owner: "Owner Password", btn_protect: "Protect",
                title_unlock: "Unlock PDF", desc_unlock: "Remove password", lbl_pass_curr: "Current Password", btn_unlock: "Unlock",
                title_delete: "Delete Pages", desc_delete: "Remove pages", lbl_del_pages: "Pages to delete", btn_delete: "Delete",
                title_sign: "Sign PDF", desc_sign: "Draw and place signature freely", lbl_draw_sig: "Draw Signature", btn_clear_sig: "Clear", btn_sign: "Save Signed PDF", btn_add_to_page: "Add to page", lbl_page: "Page", btn_prev: "Prev", btn_next: "Next",
                title_addtext: "Add Text", desc_addtext: "Add and place text boxes on PDF freely", lbl_input_text: "Input Text", lbl_font: "Font Family", btn_save_pdf: "Save PDF",
                title_metadata: "Edit Metadata", desc_metadata: "Edit Title, Author, Keywords", lbl_meta_title: "Title", lbl_meta_author: "Author", lbl_meta_subject: "Subject", lbl_meta_keywords: "Keywords", btn_metadata: "Save Metadata",
                
                msg_done: "Done!", msg_err_pdf: "Select PDF first", msg_err_pass: "Incorrect password", msg_add_files: "Files added", msg_processing: "Processing...",
                msg_err_merge: "Need 2+ PDF files", msg_err_pass_req: "Password is required", 
                msg_no_text_added: "No text added to document. Click 'Add to page' first.", msg_text_added: "Text added to current page. You can drag and resize it.", 
                msg_err_empty_text: "Please input text to add.", msg_err_no_sig: "Please draw a signature first.", 
                msg_sig_added: "Signature added to current page. You can drag and resize it.", msg_err_img: "Please select images first",
                msg_proc_page: "Processing Page {1} of {2}...",
                
                loading_init: "Initializing...", loading_gen: "Generating PDF...", loading_merge: "Merging...", loading_split: "Splitting...", 
                loading_del: "Removing Pages...", loading_comp: "Compressing...", loading_font: "Downloading Fonts...", loading_apply_sig: "Applying Signatures...", 
                loading_apply_txt: "Applying Text...", loading_apply_wm: "Applying Watermark...", loading_rotate: "Rotating...", loading_meta: "Updating Metadata...",
                
                opt_std: "Standard", opt_high: "High", opt_ultra: "Ultra", opt_smart: "Auto", opt_zip: "Always ZIP",
                opt_auto: "Fit Image", opt_no_margin: "None", opt_small: "Small", opt_std_margin: "Standard",
                opt_comp_low: "Low (Best Quality)", opt_comp_med: "Medium (Balanced)", opt_comp_high: "High (Smallest Size)",
                opt_range: "Extract Range", opt_all: "Explode (All Pages)",
                opt_last_page: "Last Page", opt_first_page: "First Page", opt_all_pages: "All Pages",
                rot_90: "Rotate Right 90°", rot_180: "Rotate 180°", rot_270: "Rotate Left 90°",
                color_gray: "Gray", color_red: "Red", color_blue: "Blue", color_black: "Black",
                pos_bc: "Bottom Center", pos_br: "Bottom Right", pos_bl: "Bottom Left", pos_tc: "Top Center", pos_tr: "Top Right",
                
                ph_pages: "e.g. 1, 3-5", ph_filename_auto: "Auto filename", ph_split: "e.g. 1-3, 5", ph_rotate: "Empty = All",
                ph_wm_text: "Watermark text...", ph_delete: "e.g. 2, 4-5",
                ph_pass_u: "Required to Open", ph_pass_o: "Required to Edit", ph_pass_unlock: "Enter password",
                ph_input_text: "Enter text here...",
                help_click_delete: "Click thumbnails to select (Red)", help_drag: "Drag to reorder", note_compress: "100% Local Processing: Your files never leave your browser.",
                privacy_note: "100% Local Processing: Your files never leave your browser.",
                ph_meta_title: "e.g. Annual Report", ph_meta_author: "e.g. John Doe", ph_meta_subject: "e.g. Meeting Minutes", ph_meta_keywords: "e.g. Finance, Accounting",
                tip_pdf: "Max size 50MB", tip_img: "Supports JPG, PNG", tip_merge: "Drag multiple files", hint_shift: "Tip: Shift+Click to select range"
            }
        };

        let curLang = 'th';
        try { const s=localStorage.getItem('cns_lang'); if(s&&['th','en'].includes(s))curLang=s; }catch(e){}
        const state = { files: {}, lists: { img2pdf: [], merge: [] }, sets: { delete: new Set(), pdf2img: new Set(), split: new Set(), rotate: new Set() }, totalPages: 0 };
        let lastSelectedPage = null; 

        function t(k){ return (i18n[curLang]&&i18n[curLang][k])?i18n[curLang][k]:k; }
        
        function applyLanguage(){
            const btn=document.getElementById('lang-label'); if(btn)btn.textContent=curLang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(i18n[curLang][k])el.textContent=i18n[curLang][k]; });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k=el.getAttribute('data-i18n-placeholder'); if(i18n[curLang][k])el.placeholder=i18n[curLang][k]; });
        }
        function toggleLanguage(){ curLang=curLang==='th'?'en':'th'; try{localStorage.setItem('cns_lang',curLang);}catch(e){} applyLanguage(); }
        applyLanguage();

        function toggleTheme() { const d=document.body.getAttribute('data-theme')==='dark'?'light':'dark'; document.body.setAttribute('data-theme',d); document.getElementById('theme-icon').className=d==='dark'?'fas fa-sun':'fas fa-moon'; try{localStorage.setItem('cns_theme',d);}catch(e){} }
        try{if(localStorage.getItem('cns_theme')==='dark')toggleTheme();}catch(e){}

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.menu-overlay').classList.toggle('active'); }
        function switchTab(id){ document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('.tool-panel').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); if(window.innerWidth<=768) toggleSidebar(); if(id==='sign') resizeCanvas(); }
        
        function showLoading(txt){ document.getElementById('loading-text').innerText=txt||t('msg_processing'); document.getElementById('loading-overlay').style.display='flex'; updateProgress(0); }
        function hideLoading(){ document.getElementById('loading-overlay').style.display='none'; }
        function updateProgress(p){ document.getElementById('progress-bar').style.width=`${p}%`; document.getElementById('progress-percent').innerText=`${Math.round(p)}%`; }
        function toast(m,type='success'){ const c=document.getElementById('toast-container'), e=document.createElement('div'); e.className=`toast ${type}`; e.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i><span>${m}</span>`; c.appendChild(e); setTimeout(()=>e.remove(),3000); }
        function downloadBlob(b,n){ const u=URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download=n; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(u); }
        function getOutputName(id, def){ const v=document.getElementById(`filename-${id}`)?.value.trim(); return v || `${def}_${Date.now()}`; }
        function parseRange(s,m){ if(!s||!s.trim())return[]; const p=new Set(); s.split(',').forEach(x=>{ x=x.trim(); if(x.includes('-')){ const[a,b]=x.split('-').map(Number); if(a&&b)for(let i=Math.max(1,a);i<=Math.min(m,b);i++)p.add(i); }else{ const n=Number(x); if(n&&n>=1&&n<=m)p.add(n); } }); return Array.from(p).sort((a,b)=>a-b); }
        
        const THAI_FONTS = {
            'Sarabun': 'https://cdn.jsdelivr.net/npm/@fontsource/sarabun@4.5.0/files/sarabun-thai-400-normal.woff',
            'Niramit': 'https://cdn.jsdelivr.net/npm/@fontsource/niramit@4.5.0/files/niramit-thai-400-normal.woff',
            'Krub': 'https://cdn.jsdelivr.net/npm/@fontsource/krub@4.5.0/files/krub-thai-400-normal.woff',
            'Mali': 'https://cdn.jsdelivr.net/npm/@fontsource/mali@4.5.0/files/mali-thai-400-normal.woff',
            'Prompt': 'https://cdn.jsdelivr.net/npm/@fontsource/prompt@4.5.0/files/prompt-thai-400-normal.woff'
        };
        async function fetchThaiFont(fontName = 'Sarabun') { 
            const url = THAI_FONTS[fontName] || THAI_FONTS['Sarabun'];
            return await fetch(url).then(res => res.arrayBuffer()); 
        }

        function resetTool(k){
            if(state.lists[k]) { 
                state.lists[k].forEach(x=>{if(x.url)URL.revokeObjectURL(x.url)}); 
                state.lists[k]=[]; 
                document.getElementById(`list-${k}`).innerHTML=''; 
                document.getElementById(`preview-${k}-container`).style.display='none'; 
            } else { 
                state.files[k]=null; 
                const l=document.getElementById(`label-${k}`); 
                if(l) {
                    l.innerHTML=`<i class="fas fa-cloud-upload-alt" style="font-size:3.5rem;margin-bottom:1rem;color:var(--text-sec);"></i><p>${t('drop_pdf')}</p>`;
                    const tip = document.querySelector(`#dz-${k} .drop-tip`);
                    if(tip) tip.style.display='block';
                }
            }
            if(state.sets[k]) { 
                const grid = document.getElementById(`grid-${k}`);
                if(grid) { grid.querySelectorAll('img').forEach(img => { if(img.src.startsWith('blob:')) URL.revokeObjectURL(img.src); }); }
                state.sets[k].clear(); 
                grid.innerHTML=''; 
                document.getElementById(`preview-${k}-container`).style.display='none'; 
            }
            if(k==='watermark') { document.getElementById('preview-watermark-container').style.display='none'; }
            if(k==='sign') { clearSig(); resetSignWorkspace(); }
            if(k==='addtext') { resetAddTextWorkspace(); }
            document.querySelectorAll(`#${k} input:not([type=file])`).forEach(i=>i.value='');
            lastSelectedPage = null;
            toast(t('btn_reset'));
        }

        function setupFileHandler(k,mul=false,lst=false){
            const dz=document.getElementById(`dz-${k}`), inp=document.getElementById(`inp-${k}`);
            const h = async (fs) => {
                if(!fs.length)return;
                if(mul&&lst){
                    Array.from(fs).forEach(async f=>{
                        if(k==='img2pdf'&&!f.type.startsWith('image/'))return; if(k==='merge'&&f.type!=='application/pdf')return;
                        const id=Date.now()+Math.random(), objUrl=k==='img2pdf'?URL.createObjectURL(f):null;
                        state.lists[k].push({id,file:f,url:objUrl});
                        const div=document.createElement('div'); div.className='img-card'; div.dataset.id=id;
                        div.innerHTML=k==='img2pdf'?`<img src="${objUrl}"><div class="card-remove-btn" onclick="removeItem('${k}',${id},this)"><i class="fas fa-times"></i></div>`:
                        `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-sec);"><i class="fas fa-file-pdf fa-2x"></i></div><div class="card-remove-btn" onclick="removeItem('${k}',${id},this)"><i class="fas fa-times"></i></div><div class="card-label">${f.name}</div>`;
                        document.getElementById(`list-${k}`).appendChild(div);
                        document.getElementById(`preview-${k}-container`).style.display='block';
                    });
                    toast(t('msg_add_files'));
                    const tip = dz.querySelector('.drop-tip'); if(tip) tip.style.display='none';
                } else {
                    if(fs[0].type!=='application/pdf')return toast(t('msg_err_pdf'),'error');
                    state.files[k]=fs[0];
                    document.getElementById(`label-${k}`).innerHTML=`<i class="fas fa-check-circle" style="font-size:3.5rem;color:var(--success);margin-bottom:1rem;"></i><p>${fs[0].name}</p>`;
                    const tip = dz.querySelector('.drop-tip'); if(tip) tip.style.display='none';
                    if(['pdf2img','split','rotate','delete','watermark'].includes(k)) generatePreviews(fs[0], k);
                    if(k === 'sign') initSignPreview(fs[0]);
                    if(k === 'addtext') initAddTextPreview(fs[0]); // Initialize visual text workspace
                }
            };
            dz.onclick=()=>inp.click(); dz.ondragover=e=>{e.preventDefault();dz.classList.add('dragover')}; dz.ondragleave=()=>dz.classList.remove('dragover'); dz.ondrop=e=>{e.preventDefault();dz.classList.remove('dragover');h(e.dataTransfer.files)}; inp.onchange=e=>h(e.target.files);
        }
        window.removeItem=(k,id,e)=>{ const i=state.lists[k].find(x=>x.id===id); if(i&&i.url)URL.revokeObjectURL(i.url); state.lists[k]=state.lists[k].filter(x=>x.id!==id); e.closest('.img-card').remove(); if(!state.lists[k].length)document.getElementById(`preview-${k}-container`).style.display='none'; }

        ['pdf2img','split','rotate','watermark','delete','protect','unlock','compress','pagenumber','sign','metadata', 'addtext'].forEach(k=>setupFileHandler(k)); ['img2pdf','merge'].forEach(k=>setupFileHandler(k,true,true));
        ['list-img2pdf','list-merge'].forEach(id=>new Sortable(document.getElementById(id),{animation:150}));

        // --- Signature Drawing Logic ---
        let isDrawing=false, sigColor='#000000'; const sigCanvas=document.getElementById('sig-canvas'), sigCtx=sigCanvas.getContext('2d');
        function resizeCanvas() { const r=sigCanvas.parentElement.getBoundingClientRect(); sigCanvas.width=r.width; sigCanvas.height=300; sigCtx.lineCap='round'; sigCtx.lineJoin='round'; sigCtx.lineWidth=3; sigCtx.strokeStyle=sigColor; }
        window.addEventListener('resize', resizeCanvas);
        const startDraw=(e)=>{isDrawing=true;sigCtx.beginPath();const{offsetX,offsetY}=getPos(e);sigCtx.moveTo(offsetX,offsetY)}; const draw=(e)=>{if(!isDrawing)return;e.preventDefault();const{offsetX,offsetY}=getPos(e);sigCtx.lineTo(offsetX,offsetY);sigCtx.stroke()}; const endDraw=()=>{isDrawing=false};
        function getPos(e){ if(e.touches){const r=sigCanvas.getBoundingClientRect();return{offsetX:e.touches[0].clientX-r.left,offsetY:e.touches[0].clientY-r.top}} return{offsetX:e.offsetX,offsetY:e.offsetY}; }
        sigCanvas.addEventListener('mousedown',startDraw); sigCanvas.addEventListener('mousemove',draw); sigCanvas.addEventListener('mouseup',endDraw); sigCanvas.addEventListener('touchstart',startDraw,{passive:false}); sigCanvas.addEventListener('touchmove',draw,{passive:false}); sigCanvas.addEventListener('touchend',endDraw);
        function clearSig(){sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height)} function setSigColor(btn){sigColor=btn.getAttribute('data-color');sigCtx.strokeStyle=sigColor;document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active')}

        // --- Signature PDF Visual Workspace Logic ---
        const signWorkspace = {
            pdf: null,
            currentPage: 1,
            totalPages: 1,
            data: {} // Format: { pageNum: [ { id: 'sig1', img: 'data:...', x: 0.5, y: 0.5, w: 0.2, h: 0.1 } ] }
        };

        function resetSignWorkspace() {
            signWorkspace.pdf = null;
            signWorkspace.currentPage = 1;
            signWorkspace.totalPages = 1;
            signWorkspace.data = {};
            document.getElementById('sign-workspace').style.display = 'none';
            document.getElementById('sign-pdf-wrapper').querySelectorAll('.draggable-sig').forEach(el => el.remove());
        }

        async function initSignPreview(file) {
            try {
                showLoading(t('loading_init'));
                resetSignWorkspace();
                signWorkspace.pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                signWorkspace.totalPages = signWorkspace.pdf.numPages;
                document.getElementById('sign-workspace').style.display = 'block';
                document.getElementById('sign-total-pages').innerText = signWorkspace.totalPages;
                await renderSignPage(1);
                hideLoading();
            } catch(e) {
                hideLoading();
                toast(e.message, 'error');
            }
        }

        async function renderSignPage(pageNum) {
            signWorkspace.currentPage = pageNum;
            document.getElementById('sign-current-page').innerText = pageNum;
            document.getElementById('sign-btn-prev').disabled = pageNum <= 1;
            document.getElementById('sign-btn-next').disabled = pageNum >= signWorkspace.totalPages;

            const page = await signWorkspace.pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.getElementById('sign-pdf-canvas-preview');
            const context = canvas.getContext('2d');
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            // Restore signatures for this page
            const wrapper = document.getElementById('sign-pdf-wrapper');
            wrapper.querySelectorAll('.draggable-sig').forEach(el => el.remove());
            
            if (signWorkspace.data[pageNum]) {
                signWorkspace.data[pageNum].forEach(sigData => {
                    createSignatureElement(sigData.img, sigData.x, sigData.y, sigData.w, sigData.h, sigData.id);
                });
            }
        }

        async function changeSignPage(delta) {
            saveCurrentPageSignatures(); // Save current DOM state before switching
            const newPage = signWorkspace.currentPage + delta;
            if (newPage >= 1 && newPage <= signWorkspace.totalPages) {
                await renderSignPage(newPage);
            }
        }

        function saveCurrentPageSignatures() {
            const wrapper = document.getElementById('sign-pdf-wrapper');
            const wrapperRect = wrapper.getBoundingClientRect();
            const sigs = wrapper.querySelectorAll('.draggable-sig');
            
            const pageData = [];
            sigs.forEach(sig => {
                const img = sig.querySelector('img').src;
                // Save relative positions (percentages) so it survives window resizes
                const x = sig.offsetLeft / wrapperRect.width;
                const y = sig.offsetTop / wrapperRect.height;
                const w = sig.offsetWidth / wrapperRect.width;
                const h = sig.offsetHeight / wrapperRect.height;
                pageData.push({ id: sig.id, img, x, y, w, h });
            });
            
            signWorkspace.data[signWorkspace.currentPage] = pageData;
        }

        function addSignatureToPreview() {
            const blank = document.createElement('canvas'); 
            blank.width = sigCanvas.width; 
            blank.height = sigCanvas.height;
            if (sigCanvas.toDataURL() === blank.toDataURL()) {
                return toast(t('msg_err_no_sig'), 'error');
            }

            // Create signature in the middle of the preview
            // Crop the empty space around the signature for better UX (Optional, skipping for speed, using full drawn box)
            createSignatureElement(sigCanvas.toDataURL(), 0.3, 0.4, 0.4, 0.2, 'sig_' + Date.now());
            toast(t('msg_sig_added'));
        }

        function createSignatureElement(imgSrc, relX, relY, relW, relH, id) {
            const wrapper = document.getElementById('sign-pdf-wrapper');
            const wrapperRect = wrapper.getBoundingClientRect();
            
            const sigDiv = document.createElement('div');
            sigDiv.className = 'draggable-sig';
            sigDiv.id = id;
            
            // Convert relative back to px for CSS
            sigDiv.style.left = (relX * wrapperRect.width) + 'px';
            sigDiv.style.top = (relY * wrapperRect.height) + 'px';
            sigDiv.style.width = (relW * wrapperRect.width) + 'px';
            sigDiv.style.height = (relH * wrapperRect.height) + 'px';

            const img = document.createElement('img');
            img.src = imgSrc;
            
            const resizer = document.createElement('div');
            resizer.className = 'sig-resizer';
            
            const deleter = document.createElement('div');
            deleter.className = 'sig-deleter';
            deleter.innerHTML = '<i class="fas fa-times"></i>';
            deleter.onclick = function() { sigDiv.remove(); saveCurrentPageSignatures(); };

            sigDiv.appendChild(img);
            sigDiv.appendChild(resizer);
            sigDiv.appendChild(deleter);
            wrapper.appendChild(sigDiv);

            makeElementDraggableAndResizable(sigDiv);
        }

        function makeElementDraggableAndResizable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let startW = 0, startH = 0, startX = 0, startY = 0;
            let isResizing = false;

            elmnt.onpointerdown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                if (e.target.className.includes('sig-deleter')) return;

                if (e.target.className.includes('sig-resizer')) {
                    isResizing = true;
                    startW = elmnt.offsetWidth;
                    startH = elmnt.offsetHeight;
                    startX = e.clientX || e.touches[0].clientX;
                    startY = e.clientY || e.touches[0].clientY;
                } else {
                    isResizing = false;
                    pos3 = e.clientX || e.touches[0].clientX;
                    pos4 = e.clientY || e.touches[0].clientY;
                }
                
                document.onpointerup = closeDragElement;
                document.onpointermove = elementDrag;
                
                // Add touch fallbacks just in case
                document.ontouchend = closeDragElement;
                document.ontouchmove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);

                const wrapper = document.getElementById('sign-pdf-wrapper');

                if (isResizing) {
                    const diffX = clientX - startX;
                    const diffY = clientY - startY;
                    let newW = startW + diffX;
                    let newH = startH + diffY;
                    
                    // Maintain aspect ratio roughly or allow free scale. Free scale is simpler.
                    if (newW > 30) elmnt.style.width = newW + "px";
                    if (newH > 20) elmnt.style.height = newH + "px";
                } else {
                    pos1 = pos3 - clientX;
                    pos2 = pos4 - clientY;
                    pos3 = clientX;
                    pos4 = clientY;

                    let newTop = elmnt.offsetTop - pos2;
                    let newLeft = elmnt.offsetLeft - pos1;

                    // Bound to wrapper
                    if (newTop < 0) newTop = 0;
                    if (newLeft < 0) newLeft = 0;
                    if (newTop + elmnt.offsetHeight > wrapper.offsetHeight) newTop = wrapper.offsetHeight - elmnt.offsetHeight;
                    if (newLeft + elmnt.offsetWidth > wrapper.offsetWidth) newLeft = wrapper.offsetWidth - elmnt.offsetWidth;

                    elmnt.style.top = newTop + "px";
                    elmnt.style.left = newLeft + "px";
                }
            }

            function closeDragElement() {
                document.onpointerup = null;
                document.onpointermove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
                saveCurrentPageSignatures(); // Auto-save after moving/resizing
            }
        }

        async function processSign() {
            if(!state.files.sign) return toast(t('msg_err_pdf'),'error');
            saveCurrentPageSignatures(); // Ensure current page is saved

            let hasSignatures = false;
            for (const page in signWorkspace.data) {
                if (signWorkspace.data[page] && signWorkspace.data[page].length > 0) hasSignatures = true;
            }

            if (!hasSignatures) {
                return toast(t('msg_no_text_added'), 'warning');
            }

            showLoading(t('loading_apply_sig'));
            try {
                const doc = await PDFDocument.load(await state.files.sign.arrayBuffer());
                
                // Iterate over saved state and draw
                for (const [pageNumStr, sigs] of Object.entries(signWorkspace.data)) {
                    if (sigs.length === 0) continue;
                    
                    const pageIndex = parseInt(pageNumStr) - 1;
                    const page = doc.getPage(pageIndex);
                    const { width, height } = page.getSize();

                    for (const sig of sigs) {
                        const sigImage = await doc.embedPng(sig.img);
                        
                        // Calculate absolute size on PDF
                        const finalW = sig.w * width;
                        const finalH = sig.h * height;
                        const finalX = sig.x * width;
                        
                        // PDF Y is inverted (0 is bottom)
                        const finalY = height - (sig.y * height) - finalH;

                        page.drawImage(sigImage, {
                            x: finalX,
                            y: finalY,
                            width: finalW,
                            height: finalH
                        });
                    }
                }

                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('sign','signed')}.pdf`);
                toast(t('msg_done'));
            } catch(e) {
                toast(e.message,'error')
            } 
            hideLoading();
        }

        // --- Add Text Visual Workspace Logic ---
        const addtextWorkspace = {
            pdf: null,
            currentPage: 1,
            totalPages: 1,
            data: {} // Format: { pageNum: [ { id, text, font, color, x, y, w, h } ] }
        };

        function resetAddTextWorkspace() {
            addtextWorkspace.pdf = null;
            addtextWorkspace.currentPage = 1;
            addtextWorkspace.totalPages = 1;
            addtextWorkspace.data = {};
            document.getElementById('addtext-workspace').style.display = 'none';
            document.getElementById('addtext-pdf-wrapper').querySelectorAll('.draggable-text').forEach(el => el.remove());
        }

        async function initAddTextPreview(file) {
            try {
                showLoading(t('loading_init'));
                resetAddTextWorkspace();
                addtextWorkspace.pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                addtextWorkspace.totalPages = addtextWorkspace.pdf.numPages;
                document.getElementById('addtext-workspace').style.display = 'block';
                document.getElementById('addtext-total-pages').innerText = addtextWorkspace.totalPages;
                await renderAddTextPage(1);
                hideLoading();
            } catch(e) {
                hideLoading();
                toast(e.message, 'error');
            }
        }

        async function renderAddTextPage(pageNum) {
            addtextWorkspace.currentPage = pageNum;
            document.getElementById('addtext-current-page').innerText = pageNum;
            document.getElementById('addtext-btn-prev').disabled = pageNum <= 1;
            document.getElementById('addtext-btn-next').disabled = pageNum >= addtextWorkspace.totalPages;

            const page = await addtextWorkspace.pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.getElementById('addtext-pdf-canvas-preview');
            const context = canvas.getContext('2d');
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            const wrapper = document.getElementById('addtext-pdf-wrapper');
            wrapper.querySelectorAll('.draggable-text').forEach(el => el.remove());
            
            if (addtextWorkspace.data[pageNum]) {
                addtextWorkspace.data[pageNum].forEach(tData => {
                    createAddTextElement(tData.text, tData.font, tData.color, tData.x, tData.y, tData.w, tData.h, tData.rot || 0, tData.id);
                });
            }
        }

        async function changeAddTextPage(delta) {
            saveCurrentPageTexts();
            const newPage = addtextWorkspace.currentPage + delta;
            if (newPage >= 1 && newPage <= addtextWorkspace.totalPages) {
                await renderAddTextPage(newPage);
            }
        }

        function saveCurrentPageTexts() {
            const wrapper = document.getElementById('addtext-pdf-wrapper');
            const wrapperRect = wrapper.getBoundingClientRect();
            const texts = wrapper.querySelectorAll('.draggable-text');
            
            const pageData = [];
            texts.forEach(tEl => {
                const text = tEl.getAttribute('data-text');
                const font = tEl.getAttribute('data-font');
                const color = tEl.getAttribute('data-color');
                const rot = parseFloat(tEl.getAttribute('data-rotation')) || 0;
                const x = tEl.offsetLeft / wrapperRect.width;
                const y = tEl.offsetTop / wrapperRect.height;
                const w = tEl.offsetWidth / wrapperRect.width;
                const h = tEl.offsetHeight / wrapperRect.height;
                pageData.push({ id: tEl.id, text, font, color, x, y, w, h, rot });
            });
            
            addtextWorkspace.data[addtextWorkspace.currentPage] = pageData;
        }

        function addTextToPreview() {
            const textVal = document.getElementById('text-addtext-val').value.trim();
            if (!textVal) return toast(t('msg_err_empty_text'), 'error');

            const fontVal = document.getElementById('font-addtext-val').value;
            const colorVal = document.getElementById('color-addtext-val').value;

            createAddTextElement(textVal, fontVal, colorVal, 0.2, 0.4, 0.5, 0.1, 0, 'txt_' + Date.now());
            toast(t('msg_text_added'));
        }

        function createAddTextElement(text, font, color, relX, relY, relW, relH, rot, id) {
            const wrapper = document.getElementById('addtext-pdf-wrapper');
            const wrapperRect = wrapper.getBoundingClientRect();
            
            const txtDiv = document.createElement('div');
            txtDiv.className = 'draggable-text';
            txtDiv.id = id;
            txtDiv.setAttribute('data-text', text);
            txtDiv.setAttribute('data-font', font);
            txtDiv.setAttribute('data-color', color);
            txtDiv.setAttribute('data-rotation', rot);
            
            txtDiv.style.left = (relX * wrapperRect.width) + 'px';
            txtDiv.style.top = (relY * wrapperRect.height) + 'px';
            txtDiv.style.width = (relW * wrapperRect.width) + 'px';
            txtDiv.style.height = (relH * wrapperRect.height) + 'px';
            txtDiv.style.transform = `rotate(${rot}deg)`;
            txtDiv.style.color = color;
            txtDiv.style.fontFamily = font;

            const span = document.createElement('span');
            span.innerText = text;
            span.style.fontSize = (relH * wrapperRect.height * 0.7) + 'px'; // Scale font size

            const resizer = document.createElement('div');
            resizer.className = 'text-resizer';

            const rotator = document.createElement('div');
            rotator.className = 'text-rotator';
            
            const deleter = document.createElement('div');
            deleter.className = 'text-deleter';
            deleter.innerHTML = '<i class="fas fa-times"></i>';
            deleter.onclick = function() { txtDiv.remove(); saveCurrentPageTexts(); };

            txtDiv.appendChild(span);
            txtDiv.appendChild(resizer);
            txtDiv.appendChild(rotator);
            txtDiv.appendChild(deleter);
            wrapper.appendChild(txtDiv);

            makeTextElementDraggableAndResizable(txtDiv, span);
        }

        function makeTextElementDraggableAndResizable(elmnt, spanEl) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let startW = 0, startH = 0, startX = 0, startY = 0;
            let isResizing = false;
            let isRotating = false;
            let startAngle = 0;
            let currentRotation = parseFloat(elmnt.getAttribute('data-rotation')) || 0;

            elmnt.onpointerdown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                if (e.target.className.includes('text-deleter')) return;

                if (e.target.className.includes('text-resizer')) {
                    isResizing = true;
                    isRotating = false;
                    startW = elmnt.offsetWidth;
                    startH = elmnt.offsetHeight;
                    startX = e.clientX || e.touches[0].clientX;
                    startY = e.clientY || e.touches[0].clientY;
                } else if (e.target.className.includes('text-rotator')) {
                    isRotating = true;
                    isResizing = false;
                    const rect = elmnt.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                    const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                    startAngle = Math.atan2(clientY - centerY, clientX - centerX) * (180 / Math.PI) - currentRotation;
                } else {
                    isResizing = false;
                    isRotating = false;
                    pos3 = e.clientX || e.touches[0].clientX;
                    pos4 = e.clientY || e.touches[0].clientY;
                }
                
                document.onpointerup = closeDragElement;
                document.onpointermove = elementDrag;
                document.ontouchend = closeDragElement;
                document.ontouchmove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                const wrapper = document.getElementById('addtext-pdf-wrapper');

                if (isResizing) {
                    const diffX = clientX - startX;
                    const diffY = clientY - startY;
                    let newW = startW + diffX;
                    let newH = startH + diffY;
                    
                    if (newW > 40) elmnt.style.width = newW + "px";
                    if (newH > 24) {
                        elmnt.style.height = newH + "px";
                        spanEl.style.fontSize = (newH * 0.7) + 'px'; // Scale font size relative to box height
                    }
                } else if (isRotating) {
                    const wrapperRect = wrapper.getBoundingClientRect();
                    const centerX = wrapperRect.left + elmnt.offsetLeft + elmnt.offsetWidth / 2;
                    const centerY = wrapperRect.top + elmnt.offsetTop + elmnt.offsetHeight / 2;
                    const angle = Math.atan2(clientY - centerY, clientX - centerX) * (180 / Math.PI);
                    currentRotation = angle - startAngle;
                    elmnt.style.transform = `rotate(${currentRotation}deg)`;
                    elmnt.setAttribute('data-rotation', currentRotation);
                } else {
                    pos1 = pos3 - clientX;
                    pos2 = pos4 - clientY;
                    pos3 = clientX;
                    pos4 = clientY;

                    let newTop = elmnt.offsetTop - pos2;
                    let newLeft = elmnt.offsetLeft - pos1;

                    if (newTop < 0) newTop = 0;
                    if (newLeft < 0) newLeft = 0;
                    if (newTop + elmnt.offsetHeight > wrapper.offsetHeight) newTop = wrapper.offsetHeight - elmnt.offsetHeight;
                    if (newLeft + elmnt.offsetWidth > wrapper.offsetWidth) newLeft = wrapper.offsetWidth - elmnt.offsetWidth;

                    elmnt.style.top = newTop + "px";
                    elmnt.style.left = newLeft + "px";
                }
            }

            function closeDragElement() {
                document.onpointerup = null;
                document.onpointermove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
                saveCurrentPageTexts();
            }
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16) / 255,
                g: parseInt(result[2], 16) / 255,
                b: parseInt(result[3], 16) / 255
            } : { r: 0, g: 0, b: 0 };
        }

        async function processAddText() {
            if(!state.files.addtext) return toast(t('msg_err_pdf'),'error');
            saveCurrentPageTexts();

            let hasTexts = false;
            let fontsToLoad = new Set();
            for (const page in addtextWorkspace.data) {
                if (addtextWorkspace.data[page] && addtextWorkspace.data[page].length > 0) {
                    hasTexts = true;
                    addtextWorkspace.data[page].forEach(t => fontsToLoad.add(t.font));
                }
            }

            if (!hasTexts) {
                return toast(t('msg_no_text_added'), 'warning');
            }

            showLoading(t('loading_apply_txt'));
            try {
                const doc = await PDFDocument.load(await state.files.addtext.arrayBuffer());
                doc.registerFontkit(fontkit);
                
                // Load only used fonts
                const embeddedFonts = {};
                for (let fontName of fontsToLoad) {
                    const fontBytes = await fetchThaiFont(fontName);
                    embeddedFonts[fontName] = await doc.embedFont(fontBytes);
                }
                
                for (const [pageNumStr, texts] of Object.entries(addtextWorkspace.data)) {
                    if (texts.length === 0) continue;
                    
                    const pageIndex = parseInt(pageNumStr) - 1;
                    const page = doc.getPage(pageIndex);
                    const { width, height } = page.getSize();

                    for (const txtObj of texts) {
                        const customFont = embeddedFonts[txtObj.font];
                        const rgbColor = hexToRgb(txtObj.color);
                        
                        const finalW = txtObj.w * width;
                        const finalH = txtObj.h * height;
                        const finalX = txtObj.x * width;
                        const finalYTop = txtObj.y * height;
                        
                        const fontSizeOnPdf = finalH * 0.7; // Base size on box height like in preview
                        
                        // หาจุดกึ่งกลางของกล่องข้อความ
                        const cx = finalX + finalW / 2;
                        const cy = height - finalYTop - finalH / 2;

                        const rot = txtObj.rot || 0;
                        const rotRad = -rot * (Math.PI / 180); // แปลงมุมให้เข้ากับสมการทางคณิตศาสตร์ (ทวนเข็ม)

                        // ตำแหน่งอ้างอิงของจุดเริ่มต้นการวาดข้อความ (แกนล่างซ้ายของกล่องข้อความ)
                        const offsetX = -finalW / 2;
                        const offsetY = -finalH / 2 + (finalH * 0.2); 

                        // คำนวณพิกัดแกน X, Y ใหม่เมื่อมีการหมุนรอบจุดกึ่งกลาง (cx, cy)
                        const drawX = cx + (offsetX * Math.cos(rotRad) - offsetY * Math.sin(rotRad));
                        const drawY = cy + (offsetX * Math.sin(rotRad) + offsetY * Math.cos(rotRad));

                        page.drawText(txtObj.text, {
                            x: drawX,
                            y: drawY,
                            size: fontSizeOnPdf,
                            font: customFont,
                            color: rgb(rgbColor.r, rgbColor.g, rgbColor.b),
                            rotate: degrees(-rot), // ใส่ค่าองศาการหมุนกลับทิศให้ PDF-Lib เข้าใจตรงกับ HTML
                            lineHeight: fontSizeOnPdf * 1.2
                        });
                    }
                }

                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('addtext','text_added')}.pdf`);
                toast(t('msg_done'));
            } catch(e) {
                toast(e.message,'error')
            } 
            hideLoading();
        }

        // --- Other PDF Tools Logic ---

        async function processMetadata() {
            if(!state.files.metadata) return toast(t('msg_err_pdf'),'error');
            showLoading(t('loading_meta'));
            try {
                const doc=await PDFDocument.load(await state.files.metadata.arrayBuffer());
                const title=document.getElementById('meta-title').value;
                const author=document.getElementById('meta-author').value;
                const subject=document.getElementById('meta-subject').value;
                const keywords=document.getElementById('meta-keywords').value;
                
                if(title) doc.setTitle(title);
                if(author) doc.setAuthor(author);
                if(subject) doc.setSubject(subject);
                if(keywords) doc.setKeywords(keywords.split(','));
                
                doc.setCreator("CNS PDF Tools");
                doc.setProducer("CNS PDF Tools");

                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('metadata','meta')}.pdf`);
                toast(t('msg_done'));
            } catch(e){toast(e.message,'error')} hideLoading();
        }

        async function generatePreviews(file, mode) {
            if(mode==='watermark'){
                document.getElementById('preview-watermark-container').style.display='block';
                const pdf=await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                const page=await pdf.getPage(1), vp=page.getViewport({scale:1.0}), cvs=document.createElement('canvas');
                cvs.width=vp.width; cvs.height=vp.height; await page.render({canvasContext:cvs.getContext('2d'),viewport:vp}).promise;
                const img=document.getElementById('watermark-preview-img'); img.onload=()=>updateWatermarkPreview(); img.src=cvs.toDataURL();
                return;
            }
            if(!state.sets[mode]) return;
            const grid=document.getElementById(`grid-${mode}`); document.getElementById(`preview-${mode}-container`).style.display='block';
            grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;">Loading...</div>'; state.sets[mode].clear();
            try {
                const pdf=await pdfjsLib.getDocument(await file.arrayBuffer()).promise; state.totalPages=pdf.numPages; grid.innerHTML='';
                if(mode==='pdf2img') for(let i=1;i<=pdf.numPages;i++)state.sets.pdf2img.add(i);
                for(let i=1;i<=pdf.numPages;i++){
                    // FIX: Async Check
                    if(state.files[mode] !== file) return;

                    const page=await pdf.getPage(i), vp=page.getViewport({scale:0.3}), cvs=document.createElement('canvas');
                    cvs.width=vp.width; cvs.height=vp.height; await page.render({canvasContext:cvs.getContext('2d'),viewport:vp}).promise;
                    
                    if(state.files[mode] !== file) return;

                    const div=document.createElement('div'); div.className='page-thumb'; div.dataset.page=i;
                    if(mode==='pdf2img') div.classList.add('selected-keep');
                    div.innerHTML=`<img src="${cvs.toDataURL()}"><div class="page-number">${i}</div>`;
                    div.onclick=(e)=>togglePage(i,div,mode,e);
                    grid.appendChild(div); if(i%10===0)await new Promise(r=>setTimeout(r,0));
                }
                updateInputs(mode);
            } catch(e){ grid.innerHTML=`<div style="color:red;text-align:center;">${e.name==='PasswordException'?'Password Protected':e.message}</div>`; }
        }

        function togglePage(p, el, m, event) {
            const s = state.sets[m];
            if (event && event.shiftKey && lastSelectedPage !== null) {
                const start = Math.min(lastSelectedPage, p);
                const end = Math.max(lastSelectedPage, p);
                const grid = document.getElementById(`grid-${m}`);
                for (let i = start; i <= end; i++) {
                    s.add(i);
                    const child = grid.querySelector(`[data-page="${i}"]`);
                    if (child) child.classList.add(m === 'delete' ? 'selected-delete' : 'selected-keep');
                }
            } else {
                if(s.has(p)){ s.delete(p); el.classList.remove(m==='delete'?'selected-delete':'selected-keep'); }
                else { s.add(p); el.classList.add(m==='delete'?'selected-delete':'selected-keep'); }
            }
            lastSelectedPage = p;
            updateInputs(m);
        }

        function toggleSelectAll(m,sel){ const s=state.sets[m]; s.clear(); if(sel)for(let i=1;i<=state.totalPages;i++)s.add(i); const g=document.getElementById(`grid-${m}`); Array.from(g.children).forEach((d,i)=>{if(sel)d.classList.add(m==='delete'?'selected-delete':'selected-keep');else d.classList.remove(m==='delete'?'selected-delete':'selected-keep')}); updateInputs(m); }
        function updateInputs(m){ let id=m==='delete'?'val-delete':m==='pdf2img'?'range-pdf2img':m==='split'?'val-split':m==='rotate'?'pages-rotate':null; if(!id)return; const arr=Array.from(state.sets[m]).sort((a,b)=>a-b); let r=[],s=arr[0],p=s; for(let i=1;i<arr.length;i++){if(arr[i]===p+1)p=arr[i];else{r.push(s===p?s:`${s}-${p}`);s=p=arr[i]}} if(arr.length)r.push(s===p?s:`${s}-${p}`); document.getElementById(id).value=r.join(', '); }
        
        async function updateWatermarkPreview(){ 
            const img = document.getElementById('watermark-preview-img');
            const txtInput = document.getElementById('text-watermark');
            
            if(!img.src || img.style.display === 'none') return; 

            const overlay = document.getElementById('watermark-overlay');
            const txt = txtInput.value || "CONFIDENTIAL";
            const color = document.getElementById('color-watermark').value;
            const size = parseInt(document.getElementById('size-watermark').value);
            const rot = parseInt(document.getElementById('rot-watermark').value);
            const opacity = parseInt(document.getElementById('opacity-watermark').value) / 100;

            document.getElementById('lbl-size-val').innerText = size;
            document.getElementById('lbl-rot-val').innerText = `${rot}°`;
            document.getElementById('lbl-op-val').innerText = `${Math.round(opacity*100)}%`;

            overlay.innerText = txt;
            overlay.style.color = color;
            overlay.style.opacity = opacity;
            
            // Correct scaling logic
            const pdfWidth = img.naturalWidth || 595; 
            const displayRatio = img.offsetWidth / pdfWidth;
            const visualSize = size * displayRatio;
            
            overlay.style.fontSize = `${visualSize}px`;
            overlay.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
        }

        async function processWatermark(){ 
            if(!state.files.watermark) return toast(t('msg_err_pdf'),'error'); 
            showLoading(t('loading_apply_wm')); 
            try{ 
                const doc = await PDFDocument.load(await state.files.watermark.arrayBuffer());
                
                doc.registerFontkit(fontkit);
                const fontBytes = await fetchThaiFont();
                await doc.embedFont(fontBytes); 

                const txt = document.getElementById('text-watermark').value || "CONFIDENTIAL";
                const colorVal = document.getElementById('color-watermark').value; 
                
                let r=0, g=0, b=0;
                if(colorVal.includes('rgba')){
                    const parts = colorVal.match(/\d+/g);
                    if(parts){ r=parseInt(parts[0])/255; g=parseInt(parts[1])/255; b=parseInt(parts[2])/255; }
                }

                const fontSize = parseInt(document.getElementById('size-watermark').value);
                const opacity = parseInt(document.getElementById('opacity-watermark').value) / 100;
                const rotationAngle = parseInt(document.getElementById('rot-watermark').value);

                // High-res canvas technique
                const scaleFactor = 4; 
                const canvasSize = 3000; 
                
                const cvs = document.createElement('canvas');
                cvs.width = canvasSize; 
                cvs.height = canvasSize;
                const ctx = cvs.getContext('2d');
                
                ctx.translate(canvasSize/2, canvasSize/2); 
                ctx.rotate(rotationAngle * Math.PI / 180); 
                
                ctx.font = `bold ${fontSize * scaleFactor}px 'Sarabun', sans-serif`; 
                ctx.fillStyle = `rgba(${r*255}, ${g*255}, ${b*255}, ${opacity})`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(txt, 0, 0); 

                const imgBytes = cvs.toDataURL();
                const imgEmbed = await doc.embedPng(imgBytes);
                const imgDims = imgEmbed.scale(1/scaleFactor); 
                
                const pages = doc.getPages();
                pages.forEach(p => {
                    const {width, height} = p.getSize();
                    p.drawImage(imgEmbed, {
                        x: (width / 2) - (imgDims.width / 2),
                        y: (height / 2) - (imgDims.height / 2),
                        width: imgDims.width,
                        height: imgDims.height,
                    });
                });

                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('watermark','watermarked')}.pdf`); 
                toast(t('msg_done')); 
            } catch(e){ 
                console.error(e);
                toast(e.message,'error'); 
            } 
            hideLoading(); 
        }

        function updateRotateVisuals() {
            const angle = parseInt(document.getElementById('angle-rotate').value);
            const grid = document.getElementById('grid-rotate');
            if (!grid) return;
            const imgs = grid.querySelectorAll('img');
            imgs.forEach(img => {
                img.style.transform = `rotate(${angle}deg)`;
                img.style.transition = 'transform 0.3s ease';
            });
        }

        async function processRotate(){ 
            if(!state.files.rotate) return toast(t('msg_err_pdf'),'error'); 
            
            showLoading(t('loading_rotate')); 
            try{ 
                const doc = await PDFDocument.load(await state.files.rotate.arrayBuffer());
                const ang = parseInt(document.getElementById('angle-rotate').value);
                const pageInput = document.getElementById('pages-rotate').value;
                
                let idx;
                if (!pageInput || !pageInput.trim()) {
                    idx = doc.getPageIndices(); 
                } else {
                    idx = parseRange(pageInput, doc.getPageCount()).map(p => p - 1);
                }

                idx.forEach(i => {
                    if(i >= 0 && i < doc.getPageCount()) {
                        const p = doc.getPage(i);
                        const newAngle = p.getRotation().angle + ang;
                        p.setRotation(degrees(newAngle));
                    }
                }); 

                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('rotate','rotated')}.pdf`); 
                toast(t('msg_done')); 
            } catch(e){ 
                console.error(e);
                toast(e.message,'error'); 
            } 
            hideLoading(); 
        }

        async function processPdfToImg(){ 
            if(!state.files.pdf2img)return toast(t('msg_err_pdf'),'error'); 
            showLoading(t('loading_init')); 
            try{ 
                const f=state.files.pdf2img, fmt=document.getElementById('format-pdf2img').value, sc=parseFloat(document.getElementById('scale-pdf2img').value), pdf=await pdfjsLib.getDocument(await f.arrayBuffer()).promise; 
                let pgs=parseRange(document.getElementById('range-pdf2img').value, pdf.numPages); 
                if(!pgs.length) pgs=Array.from({length:pdf.numPages},(_,i)=>i+1); 
                const zip=new JSZip(); 
                
                for(let i=0;i<pgs.length;i++){ 
                    const p=pgs[i];
                    document.getElementById('loading-text').innerText = t('msg_proc_page').replace('{1}', p).replace('{2}', pgs.length);
                    updateProgress(((i+1)/pgs.length)*100); 
                    await new Promise(r => requestAnimationFrame(r));
                    
                    const pg=await pdf.getPage(p), vp=pg.getViewport({scale:sc}), cvs=document.createElement('canvas'); 
                    cvs.width=vp.width; cvs.height=vp.height; await pg.render({canvasContext:cvs.getContext('2d'),viewport:vp}).promise; 
                    const blob=await new Promise(r=>cvs.toBlob(r,`image/${fmt}`,0.9)); 
                    zip.file(`${f.name}_${p}.${fmt==='jpeg'?'jpg':'png'}`,blob); 
                } 
                downloadBlob(await zip.generateAsync({type:"blob"}), `${getOutputName('pdf2img','images')}.zip`); 
                toast(t('msg_done')); 
            }catch(e){toast(e.message,'error')} hideLoading(); 
        }

        async function processImgToPdf(){ 
            if(!state.lists.img2pdf.length)return toast(t('msg_err_img'),'error'); 
            showLoading(t('loading_gen')); 
            try{ 
                const doc=await PDFDocument.create(), sz=document.getElementById('size-img2pdf').value, mar=parseInt(document.getElementById('margin-img2pdf').value); 
                for(let i=0;i<state.lists.img2pdf.length;i++){ 
                    updateProgress(((i+1)/state.lists.img2pdf.length)*100); 
                    await new Promise(r => requestAnimationFrame(r));
                    const item=state.lists.img2pdf[i], buf=await item.file.arrayBuffer(); 
                    let img; try{img=item.file.type==='image/jpeg'?await doc.embedJpg(buf):await doc.embedPng(buf)}catch{continue} 
                    const d=img.scale(1); 
                    if(sz==='Auto'){const p=doc.addPage([d.width,d.height]);p.drawImage(img,{x:0,y:0,width:d.width,height:d.height})}else{const pw=595.28,ph=841.89;const p=doc.addPage([pw,ph]),sw=pw-mar*2,sh=ph-mar*2,sc=Math.min(sw/d.width,sh/d.height);p.drawImage(img,{x:(pw-d.width*sc)/2,y:(ph-d.height*sc)/2,width:d.width*sc,height:d.height*sc})} 
                } 
                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('img2pdf','images')}.pdf`); 
                toast(t('msg_done')); 
            }catch(e){toast(e.message,'error')} hideLoading(); 
        }

        async function processMerge(){ 
            if(state.lists.merge.length<2)return toast(t('msg_err_merge'),'error'); 
            showLoading(t('loading_merge')); 
            try{ 
                const doc=await PDFDocument.create(); 
                for(let i=0; i<state.lists.merge.length; i++){
                    updateProgress(((i+1)/state.lists.merge.length)*100);
                    await new Promise(r => requestAnimationFrame(r));
                    const x = state.lists.merge[i];
                    const src=await PDFDocument.load(await x.file.arrayBuffer()); 
                    (await doc.copyPages(src,src.getPageIndices())).forEach(p=>doc.addPage(p)); 
                } 
                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('merge','merged')}.pdf`); 
                toast(t('msg_done')); 
            }catch(e){toast(e.message,'error')} hideLoading(); 
        }

        async function processSplit(){ 
            if(!state.files.split)return toast(t('msg_err_pdf'),'error'); 
            showLoading(t('loading_split')); 
            try{ 
                const src=await PDFDocument.load(await state.files.split.arrayBuffer()), mode=document.getElementById('mode-split').value, zip=new JSZip(); 
                if(mode==='all'){ 
                    for(let i=0;i<src.getPageCount();i++){ 
                        updateProgress(((i+1)/src.getPageCount())*100);
                        await new Promise(r => requestAnimationFrame(r));
                        const d=await PDFDocument.create(); (await d.copyPages(src,[i])).forEach(p=>d.addPage(p)); 
                        zip.file(`page_${i+1}.pdf`,await d.save()); 
                    } 
                }else{ 
                    const r=document.getElementById('val-split').value.split(','); 
                    for(let x of r){ 
                        const idx=parseRange(x,src.getPageCount()).map(p=>p-1); 
                        if(idx.length){ 
                            const d=await PDFDocument.create(); (await d.copyPages(src,idx)).forEach(p=>d.addPage(p)); 
                            zip.file(`split_${x}.pdf`,await d.save()); 
                        } 
                    } 
                } 
                downloadBlob(await zip.generateAsync({type:"blob"}), `${getOutputName('split','split')}.zip`); 
                toast(t('msg_done')); 
            }catch(e){toast(e.message,'error')} hideLoading(); 
        }

        async function processDelete(){ 
            if(!state.files.delete)return toast(t('msg_err_pdf'),'error'); 
            showLoading(t('loading_del')); 
            try{ 
                const src=await PDFDocument.load(await state.files.delete.arrayBuffer()), del=parseRange(document.getElementById('val-delete').value,src.getPageCount()).map(p=>p-1), doc=await PDFDocument.create(); 
                const kp=src.getPageIndices().filter(i=>!del.includes(i)); 
                (await doc.copyPages(src,kp)).forEach(p=>doc.addPage(p)); 
                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('delete','edited')}.pdf`); 
                toast(t('msg_done')); 
            }catch(e){toast(e.message,'error')} hideLoading(); 
        }

        async function processCompress(){ 
            if(!state.files.compress)return toast(t('msg_err_pdf'),'error'); 
            showLoading(t('loading_comp')); 
            try{ 
                const pdf=await pdfjsLib.getDocument(await state.files.compress.arrayBuffer()).promise, newDoc=await PDFDocument.create(), level=parseFloat(document.getElementById('level-compress').value); 
                for(let i=1;i<=pdf.numPages;i++){ 
                    document.getElementById('loading-text').innerText = t('msg_proc_page').replace('{1}', i).replace('{2}', pdf.numPages);
                    updateProgress((i/pdf.numPages)*100); 
                    await new Promise(r => requestAnimationFrame(r));
                    
                    const p=await pdf.getPage(i), vp=p.getViewport({scale:1.5}), cvs=document.createElement('canvas'); 
                    cvs.width=vp.width; cvs.height=vp.height; await p.render({canvasContext:cvs.getContext('2d'),viewport:vp}).promise; 
                    const blob=await new Promise(r=>cvs.toBlob(r,'image/jpeg',level)); 
                    const img=await newDoc.embedJpg(await blob.arrayBuffer()); 
                    const pg=newDoc.addPage([img.width/1.5,img.height/1.5]); 
                    pg.drawImage(img,{x:0,y:0,width:pg.getWidth(),height:pg.getHeight()}); 
                } 
                downloadBlob(new Blob([await newDoc.save()],{type:'application/pdf'}), `${getOutputName('compress','compressed')}.pdf`); 
                toast(t('msg_done')); 
            }catch(e){toast(e.message,'error')} hideLoading(); 
        }

        async function processPageNumber(){ 
            if(!state.files.pagenumber)return toast(t('msg_err_pdf'),'error'); 
            showLoading(t('loading_font')); 
            try{ 
                const doc=await PDFDocument.load(await state.files.pagenumber.arrayBuffer());
                
                doc.registerFontkit(fontkit);
                const fontBytes = await fetchThaiFont();
                const customFont = await doc.embedFont(fontBytes);
                
                const pos=document.getElementById('pos-pagenumber').value; 
                const start=parseInt(document.getElementById('start-pagenumber').value); 
                const fmt=document.getElementById('fmt-pagenumber').value; 
                const total=doc.getPageCount(); 
                
                doc.getPages().forEach((p,i)=>{ 
                    const num=start+i; 
                    let text=`${num}`; 
                    if(fmt==='p_n')text=`Page ${num}`; 
                    if(fmt==='n_of_t')text=`${num} of ${total}`; 
                    if(curLang === 'th' && fmt === 'p_n') text = `หน้า ${num}`;
                    if(curLang === 'th' && fmt === 'n_of_t') text = `${num} จาก ${total}`;

                    const ts=14, tw=customFont.widthOfTextAtSize(text,ts), {width,height}=p.getSize(); 
                    let x=20, y=20; 
                    if(pos.includes('B'))y=20; else y=height-30; 
                    if(pos.includes('C'))x=(width-tw)/2; else if(pos.includes('R'))x=width-tw-20; 
                    p.drawText(text,{x,y,size:ts,font:customFont,color:rgb(0,0,0)}); 
                }); 
                downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('pagenumber','numbered')}.pdf`); 
                toast(t('msg_done')); 
            }catch(e){toast(e.message,'error')} hideLoading(); 
        }

        async function processProtect(){ if(!state.files.protect)return toast(t('msg_err_pdf'),'error'); const u=document.getElementById('pass-protect-u').value, o=document.getElementById('pass-protect-o').value; if(!u)return toast(t('msg_err_pass_req'),'error'); showLoading(); try{ const doc=await PDFDocument.load(await state.files.protect.arrayBuffer()); doc.encrypt({userPassword:u, ownerPassword:o||u, permissions:{modifying:false}}); downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('protect','protected')}.pdf`); toast(t('msg_done')); }catch(e){toast(e.message,'error')} hideLoading(); }
        async function processUnlock(){ if(!state.files.unlock)return toast(t('msg_err_pdf'),'error'); const p=document.getElementById('pass-unlock').value; if(!p)return toast(t('msg_err_pass_req'),'error'); showLoading(); try{ const doc=await PDFDocument.load(await state.files.unlock.arrayBuffer(),{password:p}); downloadBlob(new Blob([await doc.save()],{type:'application/pdf'}), `${getOutputName('unlock','unlocked')}.pdf`); toast(t('msg_done')); }catch(e){toast(t('msg_err_pass'),'error')} hideLoading(); }
        
        function syncInputToPreview(mode) {
            const id = mode === 'delete' ? 'val-delete' : mode === 'pdf2img' ? 'range-pdf2img' : mode === 'split' ? 'val-split' : mode === 'rotate' ? 'pages-rotate' : null;
            if (!id) return;
            
            const val = document.getElementById(id).value;
            const s = state.sets[mode];
            s.clear();
            
            const pages = parseRange(val, state.totalPages);
            pages.forEach(p => s.add(p));

            const grid = document.getElementById(`grid-${mode}`);
            if (grid) {
                Array.from(grid.children).forEach(div => {
                    const p = parseInt(div.dataset.page);
                    if (s.has(p)) div.classList.add(mode === 'delete' ? 'selected-delete' : 'selected-keep');
                    else div.classList.remove(mode === 'delete' ? 'selected-delete' : 'selected-keep');
                });
            }
        }

        function toggleSplitMode() {
            const mode = document.getElementById('mode-split').value;
            const group = document.getElementById('group-range-split');
            if (group) group.style.display = (mode === 'all') ? 'none' : 'block';
        }
    </script>
</body>
</html>


